<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Administración</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body { background: #f6f7fb; }
    .app-navbar { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 16px; }
    .dashboard-card { border: 1px solid #e9ecef; border-radius: 12px; background: #fff; padding: 18px; height: 140px; transition: transform .12s ease, box-shadow .12s ease; display:flex; flex-direction:column; justify-content:space-between; }
    .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .dashboard-card .title { font-weight: 600; font-size: 1.05rem; color: #0d1b2a; }
    .dashboard-card .desc { color: #6c757d; font-size: .92rem; }
    .nav-sep { height:1px; background:#eef1f5; margin: 12px 0 0; }
    .badge-proveedor { background:#eef6ff; color:#0b5ed7; border:1px solid #d7e8ff; }
    .link-reset { text-decoration: none; color: inherit; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar app-navbar sticky-top py-2">
    <div class="container-fluid px-3">
      <div class="d-flex align-items-center gap-2">
        <span class="fs-5 fw-semibold">Administración</span>
        <span class="text-secondary">/</span>
        <span class="text-secondary">Dashboard</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="currentProveedorBadge" class="badge rounded-pill badge-proveedor d-none"></span>
        <button class="btn btn-outline-primary btn-sm" type="button" onclick="window.AbrirSelectorProveedor()">
          Cambiar proveedor
        </button>
      </div>
    </div>
    <div class="nav-sep"></div>
  </nav>

  <!-- MAIN -->
  <main class="container py-4">
    <div class="mb-3">
      <h1 class="h4 mb-1">Panel de gestión</h1>
      <p class="text-secondary mb-0">Elegí una opción para continuar.</p>
    </div>

    <div class="dashboard-grid">
      <!-- Mis datos -->
      <a class="link-reset" data-scope="proveedor" href="/administracion/mis-datos/" aria-label="Mis datos">
        <div class="dashboard-card card-mis-datos">
          <div>
            <div class="title">Mis datos</div>
            <div class="desc">Información del proveedor, contactos y más.</div>
          </div>
          <div class="text-end"><span class="text-primary">Ir »</span></div>
        </div>
      </a>

      <!-- Comprobantes -->
      <a class="link-reset" data-scope="proveedor" href="/administracion/comprobantes/" aria-label="Comprobantes">
        <div class="dashboard-card">
          <div>
            <div class="title">Comprobantes</div>
            <div class="desc">Carga y consulta de comprobantes.</div>
          </div>
          <div class="text-end"><span class="text-primary">Ir »</span></div>
        </div>
      </a>

      <!-- Resumen de cuenta -->
      <a class="link-reset" data-scope="proveedor" href="/administracion/resumen-cuenta/" aria-label="Resumen de cuenta">
        <div class="dashboard-card">
          <div>
            <div class="title">Resumen de cuenta</div>
            <div class="desc">Consulta de movimientos y saldos.</div>
          </div>
          <div class="text-end"><span class="text-primary">Ir »</span></div>
        </div>
      </a>

      <!-- (Agregá más tarjetas si es necesario) -->
    </div>
  </main>

  <!-- MODAL: Selector de Proveedor -->
  <div class="modal fade" id="proveedorSelectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Seleccionar proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input id="buscarProveedor" class="form-control" placeholder="Buscar proveedor por código o nombre..." />
          </div>
          <div id="listaProveedores" class="list-group" style="max-height: 60vh; overflow:auto"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- ProveedorScope (inline para que el archivo sea autocontenido) -->
  <script>
  (function (w) {
    const KEY = 'proveedor_id';
    function getFromQS() {
      const p = new URLSearchParams(w.location.search).get('proveedor_id');
      return p ? parseInt(p, 10) : null;
    }
    function get() {
      const qs = getFromQS();
      if (qs) return qs;
      const ss = parseInt(sessionStorage.getItem(KEY) || '0', 10) || null;
      const ls = parseInt(localStorage.getItem(KEY) || '0', 10) || null;
      return ss || ls;
    }
    function set(id, persist = false) {
      if (!id) return;
      sessionStorage.setItem(KEY, String(id));
      if (persist) localStorage.setItem(KEY, String(id));
    }
    function ensureOnLinks() {
      const id = get();
      if (!id) return;
      document.querySelectorAll('a[data-scope="proveedor"]').forEach(a => {
        const url = new URL(a.getAttribute('href'), location.origin);
        url.searchParams.set('proveedor_id', id);
        a.setAttribute('href', url.toString());
      });
    }
    w.ProveedorScope = { get, set, getFromQS, ensureOnLinks };
  })(window);
  </script>

  <!-- Lógica del modal y carga de proveedores -->
  <script>
(function () {
  const modalEl = document.getElementById('proveedorSelectorModal');
  const modal = new bootstrap.Modal(modalEl);
  const lista = document.getElementById('listaProveedores');
  const search = document.getElementById('buscarProveedor');
  const badge = document.getElementById('currentProveedorBadge');

  // ===== Utilidades =====
  function debounce(fn, delay) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); }; }
  let abortCtrl;

  async function changeDbConnection(codPais) {
    console.log(`Enviando solicitud para cambiar la conexión a la DB para el país: ${codPais}`);
    const apiUrl = `/administracion/api/cambiar-conexion/`;
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Include CSRF token for POST requests
            },
            body: JSON.stringify({ cod_pais: codPais }),
        });
        const responseData = await response.json();
        if (!response.ok) {
            console.error('Error en la API al cambiar la conexión:', response.status, responseData);
            return false;
        }
        console.log('Respuesta del servidor al cambiar la conexión:', responseData);
        return true;
    } catch (error) {
        console.error('Error de fetch al cambiar la conexión:', error);
        return false;
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }

  async function fetchProveedores(q = '') {
    if (abortCtrl) abortCtrl.abort();
    abortCtrl = new AbortController();

    const url = new URL('/administracion/api/proveedores/', location.origin);
    if (q) url.searchParams.set('search', q);

    const r = await fetch(url, { signal: abortCtrl.signal, headers: { 'Accept': 'application/json' } });
    if (!r.ok) throw new Error('No se pudo cargar proveedores');
    return r.json();
  }

  function paintBadge(id, texto) {
    if (!badge) return;
    if (!id) { badge.classList.add('d-none'); return; }
    badge.textContent = `Proveedor #${id}${texto ? ' – ' + texto : ''}`;
    badge.classList.remove('d-none');
  }

  function renderList(items) {
    lista.innerHTML = '';
    if (!items.length) {
      lista.innerHTML = '<div class="p-3 text-muted">Sin resultados</div>';
      return;
    }
    items.forEach(p => {
      const nombre = p.nom_provee || p.razon_social || p.nombre || p.display || '';
      const codigo = p.cod_cpa01 || p.cod_provee || '';
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'list-group-item list-group-item-action';
      a.textContent = `${codigo || '—'} – ${nombre || '—'}`;
      a.dataset.providerId = p.id;
      a.dataset.codPais = p.cod_pais;
      a.addEventListener('click', async e => {
        e.preventDefault();
        const connectionChanged = await changeDbConnection(p.cod_pais);
        if (connectionChanged) {
            ProveedorScope.set(p.id, true);
            modal.hide();
            ProveedorScope.ensureOnLinks();
            paintBadge(p.id, nombre);
            const url = new URL(location.href);
            url.searchParams.set('proveedor_id', p.id);
            location.href = url.toString();
        } else {
            alert('Error al cambiar la conexión de la base de datos. Por favor, revise la consola para más detalles.');
        }
      });
      lista.appendChild(a);
    });
  }

  const render = debounce(async function () {
    const q = search.value.trim();
    lista.innerHTML = '<div class="p-3 text-muted">Cargando...</div>';
    try {
      const data = await fetchProveedores(q);
      const items = Array.isArray(data) ? data : (data.results || []);
      const norm = s => (s || '').toString().toLowerCase();
      const filtered = q ? items.filter(p => {
        const nombre = norm(p.nom_provee || p.razon_social || p.nombre || p.display);
        const codigo = norm(p.cod_cpa01 || p.cod_provee);
        return nombre.includes(norm(q)) || codigo.includes(norm(q));
      }) : items;
      renderList(filtered);
    } catch (e) {
      if (e.name === 'AbortError') return;
      lista.innerHTML = '<div class="p-3 text-danger">Error al cargar proveedores</div>';
    }
  }, 250);

  ['input','keyup','change'].forEach(evt => search.addEventListener(evt, render));

  function openIfNeeded() {
    const id = ProveedorScope.get();
    if (!id) { render(); modal.show(); }
    else { ProveedorScope.ensureOnLinks(); paintBadge(id); }
  }

  window.AbrirSelectorProveedor = () => { render(); modal.show(); };
  openIfNeeded();
})();
</script>
</body>
</html>
