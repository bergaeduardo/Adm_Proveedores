<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <title>Mis Datos de Proveedor</title>
  <style>
    .required-label::after {
      content: " *";
      color: red;
    }
    .btn-save {
      display: none;
      float: right;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2>Mis Datos de Proveedor</h2>
    <form id="proveedorForm" class="mt-3" novalidate>
      <div id="formFields"></div>
      <div class="form-group">
        <label for="provincia">Provincia</label>
        <input type="text" class="form-control" id="provincia" name="provincia" placeholder="Buscar provincia...">
        <input type="hidden" id="id_cpa57" name="id_cpa57">
        <input type="hidden" id="nom_prov" name="nom_prov">
        <div class="list-group" id="provinciaList"></div>
      </div>
      <button type="button" class="btn btn-secondary" onclick="goToDashboard()">Volver al Inicio</button>
      <button type="submit" class="btn btn-success btn-save">Guardar Cambios</button>
      <div id="formMsg" class="alert mt-2 d-none"></div>
    </form>
    <button class="btn btn-secondary mt-3" onclick="logout()">Cerrar sesión</button>
  </div>
  <script>
    const jwt = sessionStorage.getItem('jwt');
    if (!jwt) {
      window.location.href = '/Proveedores/acceder/';
    }

    let proveedorId = null;
    let userId = null;
    let codCpa01Value = null;
    let initialData = {};
    let codPais = null; // Variable para almacenar el código de país

    const camposContactoEditables = [
      { key: "nom_fant", label: "Nombre comercial" },
      { key: "nom_provee", label: "Razon social" },
      { key: "n_cuit", label: "CUIT" },
      { key: "telefono_1", label: "Teléfono" },
      { key: "e_mail", label: "Email" },
      { key: "domicilio", label: "Dirección" },
      { key: "localidad", label: "Localidad" }
    ];

    const camposContactoObligatorios = [
      "nom_provee",
      "n_cuit",
      "telefono_1",
      "e_mail",
      "domicilio"
    ];

    const camposBloquear = ["nom_provee","nom_fant","n_cuit"];

    async function obtenerUserId() {
      const resp = await fetch('/Proveedores/api/userid/', {
        headers: { 'Authorization': 'Bearer ' + jwt }
      });
      if (!resp.ok) {
        sessionStorage.removeItem('jwt');
        window.location.href = '/Proveedores/acceder/';
        return null;
      }
      const data = await resp.json();
      return data.user_id;
    }

    async function cargarDatos() {
      userId = await obtenerUserId();
      if (!userId) return;
      const resp = await fetch('/Proveedores/api/proveedores/' + userId + '/', {
        headers: { 'Authorization': 'Bearer ' + jwt }
      });
      if (!resp.ok) {
        document.getElementById('formFields').innerHTML = '<div class="alert alert-warning">No se encontraron datos de proveedor asociados.</div>';
        return;
      }
      const proveedor = await resp.json();
      proveedorId = proveedor.id;
      codCpa01Value = proveedor.cod_cpa01;
      initialData = { ...proveedor };
      codPais = proveedor.cod_pais; // Asignar el código de país

      // Llamar a la API para cambiar la conexión
      await cambiarConexion(codPais);

      if (proveedor.id_cpa57) {
          document.getElementById('provincia').value = proveedor.nom_prov;
          document.getElementById('id_cpa57').value = proveedor.id_cpa57;
          document.getElementById('nom_prov').value = proveedor.nom_prov;
        
      }

      let html = '';
      for (const campo of camposContactoEditables) {
        const esObligatorio = camposContactoObligatorios.includes(campo.key);
        const disabled = (codCpa01Value && codCpa01Value.trim() !== "" && camposBloquear.includes(campo.key)) ? 'disabled' : '';
        html += `
          <div class="form-group">
            <label class="${esObligatorio ? 'required-label' : ''}" for="${campo.key}">${campo.label}</label>
            <input type="text" class="form-control" id="${campo.key}" name="${campo.key}" value="${proveedor[campo.key] !== null && proveedor[campo.key] !== undefined ? proveedor[campo.key] : ''}" ${esObligatorio ? 'required' : ''} ${disabled}>
            <div class="invalid-feedback" id="${campo.key}-invalid"></div>
          </div>
        `;
      }
      document.getElementById('formFields').innerHTML = html;
      agregarValidacionCuitFrontend();
      monitorChanges();
    }

    async function cambiarConexion(codPais) {
      const resp = await fetch('/Proveedores/api/cambiar-conexion/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwt
        },
        body: JSON.stringify({ cod_pais: codPais })
      });
      if (!resp.ok) {
        console.error('Error al cambiar la conexión');
      }
    }

    function monitorChanges() {
      const inputs = document.querySelectorAll('#proveedorForm input');
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          const hasChanges = Array.from(inputs).some(input => input.value !== initialData[input.name]);
          document.querySelector('.btn-save').style.display = hasChanges ? 'block' : 'none';
        });
      });
    }

    cargarDatos();

    document.getElementById('proveedorForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!proveedorId) return;

      let valido = true;
      let mensajes = [];
      camposContactoObligatorios.forEach(campo => {
        const input = document.querySelector(`[name="${campo}"]`);
        if (input && input.value.trim() === "") {
          valido = false;
          mensajes.push(`El campo "${input.previousElementSibling.textContent.replace('*', '').trim()}" es obligatorio.`);
          input.classList.add('is-invalid');
          document.getElementById(`${campo}-invalid`).textContent = `Este campo es obligatorio.`;
        } else if (input) {
          input.classList.remove('is-invalid');
          document.getElementById(`${campo}-invalid`).textContent = "";
        }
      });

      const cuitInput = document.querySelector('[name="n_cuit"]');
      if (cuitInput && cuitInput.value.trim() !== "") {
        const cuitPattern = /^\d{2}-\d{8}-\d{1}$/;
        if (!cuitPattern.test(cuitInput.value.trim())) {
          valido = false;
          mensajes.push('El CUIT debe tener el formato XX-XXXXXXXX-X (ejemplo: 20-31441849-3).');
          cuitInput.classList.add('is-invalid');
          document.getElementById('n_cuit-invalid').textContent = 'Formato inválido. Ejemplo: 20-31441849-3';
        } else {
          cuitInput.classList.remove('is-invalid');
          document.getElementById('n_cuit-invalid').textContent = "";
        }
      }

      const msgDiv = document.getElementById('formMsg');
      if (!valido) {
        msgDiv.textContent = mensajes.join(' ');
        msgDiv.className = 'alert alert-danger mt-2';
        msgDiv.classList.remove('d-none');
        return;
      } else {
        msgDiv.classList.add('d-none');
      }

      const data = {};
      camposContactoEditables.forEach(campo => {
        const input = document.querySelector(`[name="${campo.key}"]`);
        if (input && !input.disabled && input.value.trim() !== "") {
          data[campo.key] = input.value.trim();
        }
      });

      const idCpa57Input = document.getElementById('id_cpa57');
      const nomProvInput = document.getElementById('nom_prov');
      if (idCpa57Input && idCpa57Input.value.trim() !== "") {
        data['id_cpa57'] = idCpa57Input.value.trim();
      }
      if (nomProvInput && nomProvInput.value.trim() !== "") {
        data['nom_prov'] = nomProvInput.value.trim();
      }

      const resp = await fetch('/Proveedores/api/proveedores/' + proveedorId + '/', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwt
        },
        body: JSON.stringify(data)
      });
      if (resp.ok) {
        msgDiv.textContent = 'Datos actualizados correctamente.';
        msgDiv.className = 'alert alert-success mt-2';
        msgDiv.classList.remove('d-none');
        document.querySelector('.btn-save').style.display = 'none';
      } else {
        const err = await resp.json();
        msgDiv.textContent = 'Error: ' + JSON.stringify(err);
        msgDiv.className = 'alert alert-danger mt-2';
        msgDiv.classList.remove('d-none');
      }
    });

    function agregarValidacionCuitFrontend() {
      const cuitInput = document.querySelector('[name="n_cuit"]');
      if (cuitInput) {
        cuitInput.addEventListener('input', function() {
          const cuitPattern = /^\d{2}-\d{8}-\d{1}$/;
          if (cuitInput.value.trim() !== "" && !cuitPattern.test(cuitInput.value.trim())) {
            cuitInput.classList.add('is-invalid');
            document.getElementById('n_cuit-invalid').textContent = 'Formato inválido. Ejemplo: 20-31441849-3';
          } else {
            cuitInput.classList.remove('is-invalid');
            document.getElementById('n_cuit-invalid').textContent = "";
          }
        });
      }
    }

    function logout() {
      sessionStorage.removeItem('jwt');
      window.location.href = '/Proveedores/acceder/';
    }

    function goToDashboard() {
      window.location.href = '/Proveedores/dashboard/';
    }

    document.getElementById('provincia').addEventListener('input', async function() {
      const query = this.value;
      if (query.length < 2) {
        document.getElementById('provinciaList').innerHTML = '';
        return;
      }
      const resp = await fetch(`/Proveedores/api/provincias/?q=${query}&cod_pais=${codPais}`, {
        headers: { 'Authorization': 'Bearer ' + jwt }
      });
      if (resp.ok) {
        const provincias = await resp.json();
        const list = provincias.map(p => `<button type="button" class="list-group-item list-group-item-action" data-id="${p.id}" data-nom="${p.display}">${p.display}</button>`).join('');
        document.getElementById('provinciaList').innerHTML = list;
      }
    });

    document.getElementById('provinciaList').addEventListener('click', function(e) {
      if (e.target && e.target.matches('button.list-group-item')) {
        const selectedText = e.target.textContent;
        const selectedId = e.target.getAttribute('data-id');
        const selectedNom = e.target.getAttribute('data-nom');
        document.getElementById('provincia').value = selectedText;
        document.getElementById('id_cpa57').value = selectedId;
        document.getElementById('nom_prov').value = selectedNom;
        document.getElementById('provinciaList').innerHTML = '';
      }
    });
  </script>
</body>
</html>
