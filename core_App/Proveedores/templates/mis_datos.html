<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <title>Mis Datos de Proveedor</title>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background-color: #f8f9fa; /* Light gray background */
      color: #333;
    }

    .container {
      max-width: 1140px; /* Or your preferred max-width */
    }

    h2 {
      font-weight: 600;
      color: #2c3e50; /* Darker, more corporate blue/grey */
    }
    
    h5 {
        font-weight: 600;
        color: #34495e; /* Slightly lighter than h2 */
        margin-bottom: 1rem; /* Consistent spacing */
    }

    .card { /* General card enhancements */
        border: none; /* Remove default border, rely on shadow */
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.075); /* Softer, more diffused shadow */
        border-radius: 0.5rem; /* Slightly more rounded corners */
    }

    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #e9ecef; /* Lighter border */
    }
    
    .card-header-tabs {
      margin-bottom: -0.75rem;
    }

    .nav-tabs .nav-link {
        font-weight: 500;
        color: #6c757d; /* Muted color for inactive tabs */
        border: none;
        border-bottom: 3px solid transparent;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }

    .nav-tabs .nav-link:hover,
    .nav-tabs .nav-link:focus {
        color: #0d6efd; /* Bootstrap primary for hover */
        border-bottom-color: #0d6efd;
    }

    .nav-tabs .nav-link.active {
        color: var(--bs-primary, #0d6efd);
        background-color: transparent; /* Keep background transparent */
        border-color: var(--bs-primary, #0d6efd);
        font-weight: 600; /* Make active tab bolder */
    }

    .form-control, .form-select {
        border-radius: 0.375rem; /* Bootstrap default, good */
        border-color: #ced4da;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
    }

    .required-label::after {
      content: " *";
      color: var(--bs-danger);
    }

    .btn-save {
      display: none;
      font-weight: 500;
    }
    
    .btn {
        font-weight: 500;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem; /* Consistent padding */
    }
    .btn-primary {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
    .btn-primary:hover {
        background-color: #0b5ed7; /* Darken primary on hover */
        border-color: #0a58ca;
    }
    .btn-success {
        background-color: var(--bs-success);
        border-color: var(--bs-success);
    }
     .btn-success:hover {
        background-color: #157347; 
        border-color: #146c43;
    }
    .btn-outline-danger:hover {
        color: #fff;
    }


    #provinciaList .list-group-item {
      cursor: pointer;
      border-radius: 0; /* Remove individual item radius for cleaner look in dropdown */
    }
    #provinciaList .list-group-item:first-child {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    #provinciaList .list-group-item:last-child {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }


    /* Document Card Specifics */
    .document-card {
      border: 1px solid #e9ecef; /* Lighter border for cards */
      border-radius: 0.5rem; 
      background-color: #fff;
      transition: transform 0.25s ease-out, box-shadow 0.25s ease-out; /* Smoother transition */
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05); /* Softer initial shadow */
      display: flex;
      flex-direction: column;
      height: 100%; 
    }

    .document-card:hover {
      transform: translateY(-5px); /* Slightly more lift on hover */
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1); /* More pronounced shadow on hover */
    }

    .document-card-body {
      padding: 1.5rem; /* More padding */
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between; 
      flex-grow: 1; 
    }

    .document-icon-area {
      font-size: 2.25rem; /* Slightly larger icon */
      margin-bottom: 1rem;
    }
    .document-icon-area svg {
        width: 32px; /* Explicit size for SVG */
        height: 32px;
    }

    .document-title {
      font-size: 1rem; /* Slightly larger for readability */
      font-weight: 600; /* Bolder title */
      margin-bottom: 0.5rem;
      color: #343a40; /* Darker text for title */
      min-height: 40px; /* Ensure titles align if some wrap */
    }

    .required-asterisk {
      color: var(--bs-danger, #dc3545); 
      font-weight: bold;
    }

    .document-status-text {
      font-size: 0.875rem; /* Slightly larger status text */
      color: #6c757d; 
      margin-bottom: 1.25rem;
      min-height: 40px; /* Ensure consistent height */
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%; 
      padding: 0.6rem 0.75rem; /* Slightly more padding */
      font-weight: 500;
    }
    .action-btn svg {
        vertical-align: middle;
        margin-right: 0.35rem;
    }

    /* Status indicators using left border (already good, slight color tweak) */
    .document-card.status-present {
      border-left: 5px solid var(--bs-success, #198754); 
    }
    .document-card.status-present .status-icon {
      color: var(--bs-success, #198754);
    }

    .document-card.status-required-missing {
      border-left: 5px solid var(--bs-danger, #dc3545); 
    }
    .document-card.status-required-missing .status-icon {
      color: var(--bs-danger, #dc3545);
    }
    .document-card.status-required-missing .document-title .required-asterisk {
      animation: pulse-danger 1.5s infinite ease-in-out; 
    }

    .document-card.status-optional-missing {
      border-left: 5px solid var(--bs-secondary, #6c757d); 
    }
    .document-card.status-optional-missing .status-icon {
      color: var(--bs-secondary, #6c757d);
    }

    @keyframes pulse-danger {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    .file-input {
      display: none;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05); /* Subtle hover for table rows */
    }
    
    .modal-header {
        background-color: #f8f9fa; /* Light header for modal */
        border-bottom: 1px solid #dee2e6;
    }
    .modal-title {
        font-weight: 600;
        color: #343a40;
    }

  </style>
</head>
<body>
  <div class="container mt-4 mb-5"> <!-- Added mb-5 for bottom spacing -->
    <h2 class="mb-4 text-center">Mis Datos de Proveedor</h2> <!-- Centered and more margin -->
    <div class="card card-primary card-outline card-outline-tabs">
      <div class="card-header border-bottom-0">
        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="home-tab-btn" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Home</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab-btn" data-bs-toggle="tab" data-bs-target="#config-tab-pane" type="button" role="tab" aria-controls="config-tab-pane" aria-selected="false">Configuración</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="messages-tab-btn" data-bs-toggle="tab" data-bs-target="#messages-tab-pane" type="button" role="tab" aria-controls="messages-tab-pane" aria-selected="false">Mensajes</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="documents-tab-btn" data-bs-toggle="tab" data-bs-target="#documents-tab-pane" type="button" role="tab" aria-controls="documents-tab-pane" aria-selected="false">Documentos</button>
          </li>
        </ul>
      </div>
      <div class="card-body p-lg-4"> <!-- Increased padding on larger screens -->
        <div class="tab-content" id="myTabContent">
          <!-- Home Tab Pane -->
          <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab-btn" tabindex="0">
            <form id="proveedorForm" class="mt-3" novalidate>
              <h5 class="mt-3 mb-3">Datos de empresa</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label required-label" for="nom_provee">Razón social</label>
                  <input type="text" class="form-control" id="nom_provee" name="nom_provee" required>
                  <div class="invalid-feedback" id="nom_provee-invalid"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label required-label" for="n_cuit">CUIT</label>
                  <input type="text" class="form-control" id="n_cuit" name="n_cuit" required>
                  <div class="invalid-feedback" id="n_cuit-invalid"></div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label required-label" for="domicilio">Domicilio</label>
                <input type="text" class="form-control" id="domicilio" name="domicilio" required>
                <div class="invalid-feedback" id="domicilio-invalid"></div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="localidad" class="form-label">Localidad</label>
                  <input type="text" class="form-control" id="localidad" name="localidad">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="c_postal" class="form-label">Código postal</label>
                  <input type="text" class="form-control" id="c_postal" name="c_postal">
                </div>
              </div>
              <div class="mb-3">
                <label for="provincia" class="form-label">Provincia</label>
                <input type="text" class="form-control" id="provincia" name="provincia_display" placeholder="Buscar provincia...">
                <input type="hidden" id="id_cpa57" name="id_cpa57">
                <input type="hidden" id="nom_prov" name="nom_prov">
                <div class="list-group mt-1 position-absolute" style="z-index: 1000;" id="provinciaList"></div> <!-- Added position absolute and z-index -->
              </div>

              <h5 class="mt-4 mb-3">Datos de contacto</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label required-label" for="telefono_1">Teléfono</label>
                  <input type="text" class="form-control" id="telefono_1" name="telefono_1" required>
                  <div class="invalid-feedback" id="telefono_1-invalid"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="telefono_2" class="form-label">Teléfono 2</label>
                  <input type="text" class="form-control" id="telefono_2" name="telefono_2">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="telefono_movil" class="form-label">Teléfono Móvil</label>
                  <input type="text" class="form-control" id="telefono_movil" name="telefono_movil">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label required-label" for="e_mail">Email</label>
                  <input type="email" class="form-control" id="e_mail" name="e_mail" required>
                  <div class="invalid-feedback" id="e_mail-invalid"></div>
                </div>
              </div>
              <div class="mb-3">
                <label for="web" class="form-label">Página web</label>
                <input type="text" class="form-control" id="web" name="web">
              </div>

              <h5 class="mt-4 mb-3">Información comercial</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nom_fant" class="form-label">Nombre comercial</label>
                  <input type="text" class="form-control" id="nom_fant" name="nom_fant">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="domicilio_comercial" class="form-label">Domicilio comercial</label>
                  <input type="text" class="form-control" id="domicilio_comercial" name="domicilio_comercial">
                </div>
              </div>
              <div class="mb-3">
                <label for="n_iva" class="form-label">Actividad</label>
                <input type="text" class="form-control" id="n_iva" name="n_iva">
              </div>
            </form> 
          </div>

          <!-- Configuración Tab Pane -->
          <div class="tab-pane fade" id="config-tab-pane" role="tabpanel" aria-labelledby="config-tab-btn" tabindex="0">
            <h5 class="mt-3 mb-3">Configuración General</h5>
            <form id="configForm" class="mt-3" novalidate>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="condicionIva" class="form-label">Condición de IVA</label>
                  <select class="form-select" id="condicionIva" name="condicionIva"></select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="ingresosBrutos" class="form-label">Régimen de Ingresos Brutos</label>
                  <select class="form-select" id="ingresosBrutos" name="ingresosBrutos"></select>
                </div>
              </div>
              <div class="mb-3">
                <label for="n_ing_brut" class="form-label">Nro. de ingresos brutos</label>
                <input type="text" class="form-control" id="n_ing_brut" name="n_ing_brut">
              </div>
              <h5 class="mt-4 mb-3">Datos Bancarios</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cbu" class="form-label">Clave bancaria única (CBU)</label>
                  <input type="text" class="form-control" id="cbu" name="cbu">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="descripcion_cbu" class="form-label">Descripción</label>
                  <input type="text" class="form-control" id="descripcion_cbu" name="descripcion_cbu">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cbu_2" class="form-label">Clave bancaria única 2 (CBU)</label>
                  <input type="text" class="form-control" id="cbu_2" name="cbu_2">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="descripcion_cbu_2" class="form-label">Descripción</label>
                  <input type="text" class="form-control" id="descripcion_cbu_2" name="descripcion_cbu_2">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cbu_3" class="form-label">Clave bancaria única 3 (CBU)</label>
                  <input type="text" class="form-control" id="cbu_3" name="cbu_3">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="descripcion_cbu_3" class="form-label">Descripción</label>
                  <input type="text" class="form-control" id="descripcion_cbu_3" name="descripcion_cbu_3">
                </div>
              </div>
            </form>
          </div>

          <!-- Mensajes Tab Pane -->
          <div class="tab-pane fade" id="messages-tab-pane" role="tabpanel" aria-labelledby="messages-tab-btn" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
              <h5 class="mb-0">Contactos de Mensajería</h5>
              <button type="button" class="btn btn-primary" id="btnNuevoContacto">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill me-1" viewBox="0 0 16 16">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
                </svg>
                Nuevo Contacto
              </button>
            </div>
            <div id="mensajesStatus" class="alert d-none"></div>
            <div class="table-responsive">
              <table class="table table-hover align-middle"> <!-- Added align-middle -->
                <thead class="table-light"> <!-- Lighter thead -->
                  <tr>
                    <th>Nombre</th>
                    <th>Cargo</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th class="text-center">Habitual</th>
                    <th class="text-center">Recibe OC</th>
                    <th class="text-center">Recibe OP</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaContactosBody">
                  <tr>
                    <td colspan="8" class="text-center py-4">Cargando contactos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Modal para Agregar/Editar Contacto -->
          <div class="modal fade" id="contactoModal" tabindex="-1" aria-labelledby="contactoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- Added modal-dialog-centered -->
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="contactoModalLabel">Agregar Contacto</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                  <form id="contactoForm" novalidate>
                    <input type="hidden" id="contactoId" name="contactoId">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="contactoNombre" class="form-label required-label">Nombre</label>
                        <input type="text" class="form-control" id="contactoNombre" name="nombre" required>
                        <div class="invalid-feedback">El nombre es obligatorio.</div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="contactoCargo" class="form-label">Cargo</label>
                        <input type="text" class="form-control" id="contactoCargo" name="cargo">
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="contactoTelefono" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="contactoTelefono" name="telefono">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="contactoMovil" class="form-label">Móvil</label>
                        <input type="text" class="form-control" id="contactoMovil" name="telefono_movil">
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="contactoEmail" class="form-label">Email</label>
                      <input type="email" class="form-control" id="contactoEmail" name="email">
                      <div class="invalid-feedback">Ingrese un email válido.</div>
                    </div>
                    <div class="mb-3">
                      <label for="contactoObservaciones" class="form-label">Observaciones</label>
                      <textarea class="form-control" id="contactoObservaciones" name="observacion" rows="2"></textarea>
                    </div>
                    <div class="row">
                      <div class="col-md-4 mb-3">
                        <div class="form-check form-switch"> <!-- Using form-switch for modern toggle -->
                          <input class="form-check-input" type="checkbox" id="contactoDefecto" name="defecto">
                          <label class="form-check-label" for="contactoDefecto">
                            Contacto habitual
                          </label>
                        </div>
                      </div>
                      <div class="col-md-4 mb-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="contactoEnviaPdfOc" name="envia_pdf_oc">
                          <label class="form-check-label" for="contactoEnviaPdfOc">
                            Recibe órdenes de compra
                          </label>
                        </div>
                      </div>
                      <div class="col-md-4 mb-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="contactoEnviaPdfOp" name="envia_pdf_op">
                          <label class="form-check-label" for="contactoEnviaPdfOp">
                            Recibe órdenes de pago
                          </label>
                        </div>
                      </div>
                    </div>
                    <div id="contactoFormMsg" class="alert d-none"></div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary" form="contactoForm" id="btnGuardarContacto">Guardar Contacto</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Documentos Tab Pane -->
          <div class="tab-pane fade" id="documents-tab-pane" role="tabpanel" aria-labelledby="documents-tab-btn" tabindex="0">
            <h5 class="mt-3 mb-4">Documentos Adjuntos</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"> <!-- Using Bootstrap grid for consistent card sizing -->
              <div class="col">
                <div class="document-card status-required-missing" id="card-cuitFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-exclamation-triangle-fill status-icon" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                      </svg>
                    </div>
                    <h6 class="document-title">Constancia de CUIT/CUIL <span class="required-asterisk">*</span></h6>
                    <p class="document-status-text">Pendiente de carga</p>
                    <button type="button" class="btn btn-primary btn-sm action-btn" onclick="triggerUpload('cuitFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                      </svg>
                      Cargar Archivo
                    </button>
                    <input type="file" id="cuitFile" name="cuitFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="document-card status-required-missing" id="card-ingBrutosFile"> 
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-exclamation-triangle-fill status-icon" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                      </svg>
                    </div>
                    <h6 class="document-title">Inscripción Ing. Brutos <span class="required-asterisk">*</span></h6>
                    <p class="document-status-text">Pendiente de carga</p>
                    <button type="button" class="btn btn-primary btn-sm action-btn" onclick="triggerUpload('ingBrutosFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar Archivo
                    </button>
                    <input type="file" id="ingBrutosFile" name="ingBrutosFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="document-card status-optional-missing" id="card-exclGananciasFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16">
                          <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                      </svg>
                    </div>
                    <h6 class="document-title">Cert. Exclusión Ganancias</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('exclGananciasFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="exclGananciasFile" name="exclGananciasFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="document-card status-optional-missing" id="card-cm05File">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Constancia CM05</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('cm05File')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="cm05File" name="cm05File" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="document-card status-optional-missing" id="card-noRetGananciasFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Cert. No Ret. Ganancias</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('noRetGananciasFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="noRetGananciasFile" name="noRetGananciasFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg,.doc,.docx">
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="document-card status-optional-missing" id="card-exclIIBBFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Cert. Exclusión IIBB</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('exclIIBBFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="exclIIBBFile" name="exclIIBBFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg,.doc,.docx">
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="document-card status-optional-missing" id="card-noRetIIBBFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Cert. No Ret. IIBB</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('noRetIIBBFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="noRetIIBBFile" name="noRetIIBBFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg,.doc,.docx">
                  </div>
                </div>
              </div>
            </div>
            <div id="documentUploadStatus" class="mt-3"></div>
          </div> 
        </div>
      </div>
      <div class="card-footer bg-light py-3"> <!-- Added py-3 for padding -->
        <div id="formMsg" class="alert mt-0 mb-3 d-none"></div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" onclick="goToDashboard()">Volver al Inicio</button>
          <button type="submit" class="btn btn-success btn-save" form="proveedorForm">Guardar Cambios</button>
        </div>
      </div>
    </div>
    <div class="text-center">
        <button class="btn btn-outline-danger mt-4 mb-4" onclick="logout()">Cerrar sesión</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  let documentosRequeridosIds = ['cuitFile', 'ingBrutosFile']; 

  // Helper para actualizar UI de tarjeta de documento
    // Esta función debe estar definida ANTES de ser llamada en cargarDatos o en los listeners de file-input
    function actualizarUICardDocumento(fileInputId, fileName, fileUrl, esRequerido) {
        const input = document.getElementById(fileInputId);
        if (!input) { /* console.warn(`Input ${fileInputId} no encontrado para UI update`);*/ return; }
        const cardBody = input.closest('.document-card-body');
        if (!cardBody) { /* console.warn(`Card body para ${fileInputId} no encontrado`);*/ return; }

        const statusTextElement = cardBody.querySelector('.document-status-text');
        const actionButton = cardBody.querySelector('.action-btn');
        const documentCard = input.closest('.document-card');
        const statusIconArea = cardBody.querySelector('.document-icon-area');

        if(!statusTextElement || !actionButton || !documentCard || !statusIconArea) {
            // console.warn(`Uno o más elementos UI no encontrados para la tarjeta ${fileInputId}`);
            return;
        }

        documentCard.classList.remove('border', 'border-danger'); 

        if (fileName && fileUrl) { 
            statusTextElement.textContent = 'Archivo cargado: ' + fileName;
            actionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill me-1" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/></svg> Ver Documento`;
            actionButton.onclick = () => viewDocument(fileUrl);
            actionButton.classList.remove('btn-primary', 'btn-outline-primary'); actionButton.classList.add('btn-outline-secondary');
            documentCard.classList.remove('status-required-missing', 'status-optional-missing'); documentCard.classList.add('status-present');
            statusIconArea.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill status-icon" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>`;
        } else { 
            statusTextElement.textContent = esRequerido ? 'Pendiente de carga' : 'Opcional, no cargado';
            actionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg> ${esRequerido ? 'Cargar Archivo' : 'Cargar (Opcional)'}`;
            actionButton.onclick = () => triggerUpload(fileInputId);
            actionButton.classList.remove('btn-outline-secondary'); actionButton.classList.add(esRequerido ? 'btn-primary' : 'btn-outline-primary');
            documentCard.classList.remove('status-present'); documentCard.classList.add(esRequerido ? 'status-required-missing' : 'status-optional-missing');
            const iconClass = esRequerido ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';
            const iconPath = esRequerido ? "M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2" : "M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2";
            statusIconArea.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi ${iconClass} status-icon" viewBox="0 0 16 16"><path d="${iconPath}"/></svg>`;
        }
    }
  
  $(document).ready(function() {
    // const jwt = sessionStorage.getItem('jwt'); // Se obtiene dentro de obtenerUserId
    // if (!jwt) { // Esta verificación también se hace en obtenerUserId
    //   window.location.href = '/Proveedores/acceder/';
    //   return; 
    // }

    let proveedorId = null;
    let userId = null;
    let codCpa01Value = null;
    let initialData = {}; 
    let codPais = null;

    const camposPrincipalesEditables = [ 
      { key: "nom_provee", label: "Razon social" }, { key: "n_cuit", label: "CUIT" },
      { key: "domicilio", label: "Domicilio" }, { key: "localidad", label: "Localidad" },
      { key: "c_postal", label: "Código postal" }, { key: "telefono_1", label: "Teléfono" },
      { key: "telefono_2", label: "Teléfono 2" }, { key: "telefono_movil", label: "Teléfono móvil" },
      { key: "e_mail", label: "Email" }, { key: "web", label: "Pagina Web" },
      { key: "nom_fant", label: "Nombre comercial" }, { key: "domicilio_comercial", label: "Domicilio comercial" },
      { key: "n_iva", label: "Actividad" }, { key: "n_ing_brut", label: "Nro. de ingresos brutos" },
      { key: "cbu", label: "Clave bancaria única (CBU)" }, { key: "descripcion_cbu", label: "Descripción" },
      { key: "cbu_2", label: "Clave bancaria única 2 (CBU)" }, { key: "descripcion_cbu_2", label: "Descripción" },
      { key: "cbu_3", label: "Clave bancaria única 3 (CBU)" }, { key: "descripcion_cbu_3", label: "Descripción" },
    ];
    const camposContactoObligatorios = ["nom_provee", "n_cuit", "telefono_1", "e_mail", "domicilio"];
    
    const camposBloquear = ["nom_provee","nom_fant","n_cuit"];

    

    async function obtenerUserId() {
      const JW_TOKEN = sessionStorage.getItem('jwt');
      if (!JW_TOKEN) {
          console.warn('No se encontró JWT en sessionStorage. Redirigiendo a la página de acceso.');
          window.location.href = '/Proveedores/acceder/';
          return null; 
      }
      try {
        const resp = await fetch('/Proveedores/api/userid/', { headers: { 'Authorization': 'Bearer ' + JW_TOKEN }});
        if (!resp.ok) {
          console.error(`Error al obtener User ID. Estado: ${resp.status}, Texto: ${resp.statusText}`);
          if (resp.status === 401 || resp.status === 403) {
            console.log('Error de autenticación (401/403). Limpiando JWT y redirigiendo a la página de acceso.');
            sessionStorage.removeItem('jwt');
            window.location.href = '/Proveedores/acceder/';
          }
          return null;
        }
        const data = await resp.json();
        if (!data || data.user_id === undefined) {
            console.error('User ID no encontrado en la respuesta de /api/userid/. Respuesta:', data);
            return null;
        }
        console.log('User ID obtenido:', data.user_id);
        return data.user_id;
      } catch (error) { 
        console.error('Error de red durante la obtención de User ID (/api/userid/):', error);
        sessionStorage.removeItem('jwt'); 
        window.location.href = '/Proveedores/acceder/'; 
        return null;
      }
    }

    async function cargarDatos() {
      userId = await obtenerUserId();
      const msgDivCarga = $('#formMsg');

      if (!userId) {
        msgDivCarga.text('No se pudo verificar el usuario. Redirigiendo a la página de acceso...')
                   .removeClass('d-none alert-success alert-info')
                   .addClass('alert-danger');
        if (!window.location.href.endsWith('/Proveedores/acceder/')) { 
            setTimeout(() => {
                if (!sessionStorage.getItem('jwt')) { 
                     window.location.href = '/Proveedores/acceder/';
                } else {
                    console.error("UserID es null, pero el token JWT aún existe. Podría ser un error temporal del API /api/userid/.");
                    msgDivCarga.text('Hubo un problema al obtener los datos del usuario. Por favor, intente recargar la página o contacte a soporte si el problema persiste.');
                }
            }, 2500);
        }
        return; 
      }
      msgDivCarga.addClass('d-none').removeClass('alert-danger alert-info');

      let proveedor = {};
      try {
        const resp = await fetch('/Proveedores/api/proveedores/' + userId + '/', { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (!resp.ok) {
          if (resp.status === 404) { 
            console.warn('No se encontraron datos de proveedor para el usuario. Se puede completar el formulario.');
          } else { 
            console.error('Error al cargar datos del proveedor: ' + resp.statusText, resp.status); 
            msgDivCarga.text(`Error al cargar datos del proveedor (${resp.status}). Por favor, intente más tarde.`)
                      .removeClass('d-none').addClass('alert-danger');
          }
        } else {
            proveedor = await resp.json(); 
            proveedorId = proveedor.id; 
            codCpa01Value = proveedor.cod_cpa01; 
            codPais = proveedor.cod_pais;
            console.log('Datos del proveedor cargados:', proveedor);
        }

        camposPrincipalesEditables.forEach(campo => {
          const inputElement = document.getElementById(campo.key);
          if (inputElement) {
            const value = proveedor[campo.key]; inputElement.value = (value !== null && value !== undefined) ? value : '';
            initialData[campo.key] = inputElement.value; 
            if (codCpa01Value && codCpa01Value.trim() !== "" && camposBloquear.includes(campo.key)) { inputElement.disabled = true; }
          }
        });
        
        const provinciaDisplayInput = document.getElementById('provincia');
        const idCpa57Input = document.getElementById('id_cpa57');
        const nomProvInput = document.getElementById('nom_prov');
        provinciaDisplayInput.value = proveedor.nom_prov || ''; 
        idCpa57Input.value = proveedor.id_cpa57 || ''; 
        nomProvInput.value = proveedor.nom_prov || '';
        initialData[provinciaDisplayInput.name || provinciaDisplayInput.id] = provinciaDisplayInput.value; 
        initialData[idCpa57Input.name || idCpa57Input.id] = idCpa57Input.value; 
        initialData[nomProvInput.name || nomProvInput.id] = nomProvInput.value;

        if (codPais) { await cambiarConexion(codPais); } 

        await cargarCondicionIva(proveedor.id_categoria_iva_cond_iva);
        initialData['condicionIva'] = document.getElementById('condicionIva').value;
        
        await cargarIngresosBrutos(proveedor.tipo);
        initialData['ingresosBrutos'] = document.getElementById('ingresosBrutos').value;
        
        const messagesFormElements = document.querySelectorAll('#messagesForm input, #messagesForm select, #messagesForm textarea');
        messagesFormElements.forEach(el => {
            if (el.name || el.id) {
                const key = el.name || el.id;
                const value = proveedor[key];

                if (el.type === 'checkbox' && (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago')) {
                    el.checked = (value === 'S'); // Marcar si el valor es "S"
                    initialData[key] = el.checked ? 'S' : 'N'; // Guardar 'S' o 'N' en initialData
                } else if (el.tagName.toLowerCase() === 'select') {
                    el.value = (value !== null && value !== undefined) ? String(value) : (el.options.length > 0 ? el.options[0].value : '');
                    initialData[key] = el.value;
                } else { // Para inputs de texto, email, textarea, etc.
                    el.value = (value !== null && value !== undefined) ? value : '';
                    initialData[key] = el.value;
                }
            }
        });

        const fileInputsDocumentos = document.querySelectorAll('#documents-tab-pane .file-input');
        fileInputsDocumentos.forEach(input => {
            if (input.id) {
                const fileInfo = proveedor.documentos_data ? proveedor.documentos_data[input.id] : null;
                const esRequerido = documentosRequeridosIds.includes(input.id);
                if (fileInfo && fileInfo.name) {
                    initialData[input.id] = fileInfo.name;
                    actualizarUICardDocumento(input.id, fileInfo.name, fileInfo.url, esRequerido);
                } else {
                    initialData[input.id] = '';
                    actualizarUICardDocumento(input.id, null, null, esRequerido);
                }
            }
        });

        agregarValidacionCuitFrontend();
        monitorChanges(); 
      } catch (error) {
        console.error('Error al procesar los datos del proveedor o al cargar componentes:', error);
        msgDivCarga.text('Ocurrió un error al cargar la información de la página. Intente recargar.')
                   .removeClass('d-none').addClass('alert-danger');
        monitorChanges(); 
        agregarValidacionCuitFrontend();
      }
    }

    async function cargarCondicionIva(selectedId) {
      const select = document.getElementById('condicionIva');
      select.innerHTML = '<option value="">Seleccione...</option>';
      try {
        const resp = await fetch('/Proveedores/api/categoria-iva/', { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (resp.ok) {
          const categorias = await resp.json();
          categorias.forEach(cat => { 
            const option = document.createElement('option'); option.value = cat.id_categoria_iva; 
            option.textContent = cat.desc_categoria_iva; option.setAttribute('data-cod', cat.cod_categoria_iva); 
            select.appendChild(option); 
          });
          console.log('Condiciones de IVA cargadas.');
        } else { 
          console.error("Error cargando Condicion IVA:", resp.statusText, resp.status); 
        }
        let valorASeleccionar = ""; 
        if (selectedId !== null && selectedId !== undefined && String(selectedId).trim() !== "") {
            if (Array.from(select.options).some(opt => opt.value == String(selectedId))) {
                valorASeleccionar = String(selectedId);
            } else {
                console.warn(`Opción con valor "${selectedId}" no encontrada en Condicion IVA. Se usará el valor por defecto.`);
            }
        }
        select.value = valorASeleccionar;
      } catch (error) { 
        console.error("Network error cargando Condicion IVA:", error); 
        select.value = ""; 
      }
    }

    async function cargarIngresosBrutos(selectedTipo) {
      const select = document.getElementById('ingresosBrutos');
      select.innerHTML = '<option value="">Seleccione...</option>';
       try {
        const resp = await fetch('/Proveedores/api/ingresos-brutos/', { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (resp.ok) {
          const ingresosBrutos = await resp.json();
          ingresosBrutos.forEach(ib => { 
            const option = document.createElement('option'); option.value = ib.Cod_Ingresos_brutos; 
            option.textContent = ib.Desc_Ingresos_brutos; select.appendChild(option); 
          });
          console.log('Regímenes de Ingresos Brutos cargados.');
        } else { 
          console.error("Error cargando Ingresos Brutos:", resp.statusText, resp.status); 
        }
        let valorASeleccionar = ""; 
        if (selectedTipo !== null && selectedTipo !== undefined && String(selectedTipo).trim() !== "") {
            if (Array.from(select.options).some(opt => opt.value == String(selectedTipo))) {
                valorASeleccionar = String(selectedTipo);
            } else {
                console.warn(`Opción con valor "${selectedTipo}" no encontrada en Ingresos Brutos. Se usará el valor por defecto.`);
            }
        }
        select.value = valorASeleccionar;
      } catch (error) { 
        console.error("Network error cargando Ingresos Brutos:", error); 
        select.value = ""; 
      }
    }

    async function cambiarConexion(pais) {
        if (!pais) return;
        try {
            const resp = await fetch('/Proveedores/api/cambiar-conexion/', { 
                method: 'POST', 
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') 
                }, 
                body: JSON.stringify({ cod_pais: pais }) 
            });
            if (!resp.ok) { 
                console.error('Error al cambiar la conexión de país:', await resp.text()); 
            } else {
                console.log('Conexión de país cambiada a:', pais);
            }
        } catch (error) { 
            console.error('Network error al cambiar la conexión de país:', error); 
        }
    }
    
    function monitorChanges() {
      const inputs = document.querySelectorAll(
        '#proveedorForm input, #proveedorForm select, #proveedorForm textarea, ' +
        '#configForm input, #configForm select, #configForm textarea, ' +
        '#messagesForm input, #messagesForm select, #messagesForm textarea, ' + 
        '#documents-tab-pane .file-input' 
      );
      const saveButton = document.querySelector('.btn-save');
      const checkChanges = () => {
        let hasChanges = false;
        inputs.forEach(input => {
          const key = input.name || input.id;
          const dataKey = (input.id === 'provincia' && initialData.hasOwnProperty('provincia')) ? 'provincia' : key;
          if (input.type === 'file') {
            if (input.files && input.files.length > 0) {
              const currentFileName = input.files[0].name;
              const initialFileName = initialData[key] || '';
              if (currentFileName !== initialFileName) { hasChanges = true; }
            }
            // Considerar si un archivo fue removido como un cambio
            // else if (initialData[key] && initialData[key] !== '') { // Si había un archivo antes y ahora no hay ninguno seleccionado
            //    hasChanges = true; // Esto es un cambio (archivo borrado)
            // }
          } else {
            const key = input.name || input.id; // Asegúrate que 'key' esté definida aquí
            const dataKey = (input.id === 'provincia' && initialData.hasOwnProperty('provincia')) ? 'provincia' : key;

            if (input.type === 'file') {
              if (input.files && input.files.length > 0) {
                const currentFileName = input.files[0].name;
                const initialFileName = initialData[key] || '';
                if (currentFileName !== initialFileName) { hasChanges = true; }
              }
              // Considerar si un archivo fue removido como un cambio (opcional)
            } else if (input.type === 'checkbox' && (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago')) {
              const currentValue = input.checked ? 'S' : 'N';
              const initialValue = initialData[key] !== undefined ? String(initialData[key]) : 'N'; // Default a 'N' si no hay dato inicial
              if (currentValue !== initialValue) {
                  hasChanges = true;
              }
            } else { // Para otros inputs (texto, selects, otros checkboxes)
              const currentValue = (input.type === 'checkbox') ? input.checked.toString() : input.value;
              const initialValue = initialData[dataKey] !== undefined ? String(initialData[dataKey]) : '';
              if (String(currentValue) !== initialValue) {
                  hasChanges = true;
              }
            }
          }
        });
        saveButton.style.display = hasChanges ? 'block' : 'none';
      };
      inputs.forEach(input => {
        if (input.type === 'file' || input.tagName.toLowerCase() === 'select' || input.type === 'checkbox' || input.type === 'radio') {
            input.addEventListener('change', checkChanges);
        } else {
            input.addEventListener('input', checkChanges); input.addEventListener('change', checkChanges); 
        }
      });
    }

    function gatherFormDataFromAllTabs() { 
        const formData = new FormData(); 
        const formsToProcess = ['#proveedorForm', '#configForm', '#messagesForm'];
        formsToProcess.forEach(formSelector => {
            const formElements = document.querySelectorAll(`${formSelector} input:not([type="file"]), ${formSelector} select, ${formSelector} textarea`);
            formElements.forEach(el => {
                if ((el.name || el.id) && !el.disabled) {
                    const key = el.name || el.id;
                    if (el.type === 'checkbox' && (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago')) {
                        formData.append(key, el.checked ? 'S' : 'N'); // Enviar 'S' si está marcado, 'N' si no
                    } else if (el.type === 'checkbox') { // Para otros checkboxes (si los hubiera)
                        formData.append(key, el.checked);
                    } else if (el.type === 'radio') {
                        if (el.checked) { formData.append(key, el.value.trim() === "" ? '' : el.value.trim()); }
                    } else { // Para inputs de texto, selects, textareas
                        formData.append(key, el.value.trim() === "" ? '' : el.value.trim());
                    }
                }
            });
        });
        if (formData.has('provincia_display')) { formData.delete('provincia_display'); } // provincia_display es el input visible
        const idCpa57Val = document.getElementById('id_cpa57').value; const nomProvVal = document.getElementById('nom_prov').value;
        formData.set('id_cpa57', idCpa57Val || ''); formData.set('nom_prov', nomProvVal || '');
        formData.set('id_categoria_iva_cond_iva', document.getElementById('condicionIva').value || '');
        if (formData.has('condicionIva')) formData.delete('condicionIva');
        formData.set('tipo', document.getElementById('ingresosBrutos').value || '');
        if (formData.has('ingresosBrutos')) formData.delete('ingresosBrutos');
        const fileInputsDocumentos = document.querySelectorAll('#documents-tab-pane .file-input');
        fileInputsDocumentos.forEach(input => {
            if (input.id && input.files && input.files.length > 0) {
                formData.append(input.id, input.files[0], input.files[0].name); 
            }
        });
        return formData;
    }

    document.getElementById('proveedorForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      let valido = true; let mensajes = [];
      camposContactoObligatorios.forEach(campoKey => {
          const input = document.getElementById(campoKey);
          if (input && input.value.trim() === "") {
              valido = false; const labelText = input.previousElementSibling?.textContent.replace('*', '').trim() || campoKey;
              mensajes.push(`El campo "${labelText}" (pestaña Home) es obligatorio.`); input.classList.add('is-invalid');
              const feedbackEl = document.getElementById(`${campoKey}-invalid`); if (feedbackEl) feedbackEl.textContent = `Este campo es obligatorio.`;
          } else if (input) { input.classList.remove('is-invalid'); const feedbackEl = document.getElementById(`${campoKey}-invalid`); if (feedbackEl) feedbackEl.textContent = "";}
      });
      const cuitInputHTML = document.getElementById('n_cuit');
      if (cuitInputHTML && cuitInputHTML.value.trim() !== "") {
          const cuitPattern = /^\d{2}-\d{8}-\d{1}$/;
          if (!cuitPattern.test(cuitInputHTML.value.trim())) {
              valido = false; mensajes.push('El CUIT (pestaña Home) debe tener el formato XX-XXXXXXXX-X.');
              cuitInputHTML.classList.add('is-invalid'); const feedbackEl = document.getElementById('n_cuit-invalid'); if (feedbackEl) feedbackEl.textContent = 'Formato inválido. Ejemplo: 20-31441849-3';
          } else { if (cuitInputHTML.classList.contains('is-invalid')) { cuitInputHTML.classList.remove('is-invalid'); const feedbackEl = document.getElementById('n_cuit-invalid'); if (feedbackEl) feedbackEl.textContent = "";}}
      }
      let primerDocumentoFaltante = null;
      documentosRequeridosIds.forEach(fileInputId => {
          const fileInput = document.getElementById(fileInputId); const documentCard = document.getElementById(`card-${fileInputId}`);
          const documentTitleElement = documentCard ? documentCard.querySelector('.document-title') : null;
          const documentName = documentTitleElement ? documentTitleElement.textContent.replace('*','').trim() : `Documento ${fileInputId}`;
          const yaCargadoPreviamenteConNombre = initialData[fileInputId] && initialData[fileInputId] !== '';
          const nuevoArchivoSeleccionado = fileInput && fileInput.files && fileInput.files.length > 0;
          if (!nuevoArchivoSeleccionado && !yaCargadoPreviamenteConNombre) {
              valido = false; mensajes.push(`El documento "${documentName}" (pestaña Documentos) es requerido.`);
              if (documentCard) { documentCard.classList.add('border', 'border-danger'); }
              if (!primerDocumentoFaltante) { primerDocumentoFaltante = fileInputId; }
          } else if (documentCard) { documentCard.classList.remove('border', 'border-danger'); }
      });
      const msgDiv = document.getElementById('formMsg');
      if (!valido) {
          msgDiv.innerHTML = mensajes.join('<br>'); msgDiv.className = 'alert alert-danger mt-0 mb-3'; msgDiv.classList.remove('d-none');
          if (primerDocumentoFaltante && !mensajes.some(m => m.includes("pestaña Home"))) { 
              const documentsTabButton = document.getElementById('documents-tab-btn');
              if (documentsTabButton) { new bootstrap.Tab(documentsTabButton).show(); }
          } return; 
      } else { msgDiv.classList.add('d-none'); msgDiv.textContent = '';}
      const formDataToSave = gatherFormDataFromAllTabs(); const method = proveedorId ? 'PATCH' : 'POST';
      let url = proveedorId ? `/Proveedores/api/proveedores/${proveedorId}/` : `/Proveedores/api/proveedores/`;
      if (method === 'POST') { if (userId) formDataToSave.append('user', userId); if (codPais) formDataToSave.append('cod_pais', codPais); }
      msgDiv.textContent = 'Guardando datos...'; msgDiv.className = 'alert alert-info mt-0 mb-3'; msgDiv.classList.remove('d-none');
      document.querySelector('.btn-save').disabled = true;
      try {
        const resp = await fetch(url, { method: method, headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt'), 'X-CSRFToken': getCookie('csrftoken') }, body: formDataToSave });
        if (resp.ok) {
          const responseData = await resp.json(); 
          if (method === 'POST' && responseData.id) {
            proveedorId = responseData.id; 
            if (responseData.cod_cpa01) { codCpa01Value = responseData.cod_cpa01; camposBloquear.forEach(keyToBlock => { const inputToBlock = document.getElementById(keyToBlock); if (inputToBlock && codCpa01Value && codCpa01Value.trim() !== "") { inputToBlock.disabled = true; }});}
            if (responseData.cod_pais) { codPais = responseData.cod_pais; }
          }
          for (const [key, value] of formDataToSave.entries()) { 
            if (value instanceof File) continue; 

            if (key === 'id_categoria_iva_cond_iva') { 
                initialData['condicionIva'] = String(value);
            } else if (key === 'tipo') { 
                initialData['ingresosBrutos'] = String(value);
            } else if (key === 'id_cpa57') { 
                initialData['id_cpa57'] = String(value); 
            } else if (key === 'nom_prov') { 
                initialData['nom_prov'] = String(value); 
            } else if (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago') {
                initialData[key] = String(value); // 'value' ya es 'S' o 'N' desde formDataToSave
            } else if (initialData.hasOwnProperty(key)) { // Para todos los demás campos que estaban en initialData
                initialData[key] = value === null ? '' : String(value);
            }
          }
          initialData[document.getElementById('provincia').name || document.getElementById('provincia').id] = formDataToSave.get('nom_prov') || '';

          const fileInputs = document.querySelectorAll('#documents-tab-pane .file-input');
          fileInputs.forEach(input => {
            if (input.id) {
                const docDataFromServer = responseData.documentos_data ? responseData.documentos_data[input.id] : null;
                const esRequerido = documentosRequeridosIds.includes(input.id);
                if (docDataFromServer && docDataFromServer.name) {
                    initialData[input.id] = docDataFromServer.name;
                    actualizarUICardDocumento(input.id, docDataFromServer.name, docDataFromServer.url, esRequerido);
                } else {
                    const fileSent = formDataToSave.get(input.id); 
                    if (fileSent instanceof File) { initialData[input.id] = fileSent.name; } 
                    else if (!initialData[input.id] && !docDataFromServer) { initialData[input.id] = ''; actualizarUICardDocumento(input.id, null, null, esRequerido); }
                }
                input.value = ''; 
            }
          });
          msgDiv.textContent = 'Datos actualizados correctamente.'; msgDiv.className = 'alert alert-success mt-0 mb-3'; msgDiv.classList.remove('d-none');
          document.querySelector('.btn-save').style.display = 'none'; 
        } else { 
          const errText = await resp.text(); let err; try { err = JSON.parse(errText); } catch (e) { err = errText; }
          let errorMessages = 'Error al guardar los datos.';
          if (typeof err === 'object' && err !== null) { errorMessages = Object.entries(err).map(([key, value]) => { const fieldLabel = camposPrincipalesEditables.find(c => c.key === key)?.label || document.querySelector(`label[for="${key}"]`)?.textContent.replace('*', '').trim() || key; return `${fieldLabel}: ${Array.isArray(value) ? value.join(', ') : value}`; }).join('<br>');
          } else if (typeof err === 'string') { errorMessages = err; }
          msgDiv.innerHTML = errorMessages; msgDiv.className = 'alert alert-danger mt-0 mb-3'; msgDiv.classList.remove('d-none');
        }
      } catch (error) { 
        console.error("Error durante el guardado:", error); msgDiv.textContent = 'Error de red o problema al procesar la solicitud de guardado.';
        msgDiv.className = 'alert alert-danger mt-0 mb-3'; msgDiv.classList.remove('d-none');
      } finally { document.querySelector('.btn-save').disabled = false; }
  });

    function agregarValidacionCuitFrontend() {
      const cuitInput = document.getElementById('n_cuit');
      if (cuitInput) {
        cuitInput.addEventListener('input', function() {
          const cuitPattern = /^\d{2}-\d{8}-\d{1}$/; const feedbackEl = document.getElementById('n_cuit-invalid');
          if (cuitInput.value.trim() !== "" && !cuitPattern.test(cuitInput.value.trim())) { cuitInput.classList.add('is-invalid'); if (feedbackEl) feedbackEl.textContent = 'Formato inválido. Ejemplo: 20-31441849-3';
          } else { cuitInput.classList.remove('is-invalid'); if (feedbackEl) feedbackEl.textContent = ""; }
        });
      }
    }
    
    function getCookie(name) {
        let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; }}} return cookieValue;
    }

    document.getElementById('provincia').addEventListener('input', async function() {
      const query = this.value; const provinciaListDiv = document.getElementById('provinciaList');
      if (query.length < 2) { provinciaListDiv.innerHTML = ''; return; }
      if (!codPais && proveedorId) { // Si no hay codPais pero sí proveedor, intentar obtenerlo o usar default
        console.warn("Código de país (codPais) no establecido globalmente. Intentando usar el del proveedor o AR por defecto para búsqueda de provincia.");
        // Podrías hacer un fetch aquí para obtener codPais del proveedor si no se cargó inicialmente
        // o simplemente asumir 'AR' si es el más común.
      }
      const paisParaQuery = codPais || 'AR'; // Usar AR como fallback si codPais no está
      try {
        const resp = await fetch(`/Proveedores/api/provincias/?q=${encodeURIComponent(query)}&cod_pais=${paisParaQuery}`, { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (resp.ok) { const provincias = await resp.json(); const list = provincias.map(p => `<button type="button" class="list-group-item list-group-item-action" data-id="${p.id}" data-nom="${p.display}">${p.display}</button>`).join(''); provinciaListDiv.innerHTML = list;
        } else { console.error("Error buscando provincias:", resp.statusText); provinciaListDiv.innerHTML = '<div class="list-group-item text-danger">Error al buscar</div>'; }
      } catch (error) { console.error("Network error buscando provincias:", error); provinciaListDiv.innerHTML = '<div class="list-group-item text-danger">Error de red</div>';}
    });

    document.getElementById('provinciaList').addEventListener('click', function(e) {
      if (e.target && e.target.matches('button.list-group-item')) {
        const selectedText = e.target.textContent; const selectedId = e.target.getAttribute('data-id'); const selectedNom = e.target.getAttribute('data-nom'); 
        const provinciaInput = document.getElementById('provincia'); provinciaInput.value = selectedText;
        document.getElementById('id_cpa57').value = selectedId; document.getElementById('nom_prov').value = selectedNom; 
        document.getElementById('provinciaList').innerHTML = ''; 
        $(provinciaInput).trigger('input').trigger('change'); $(document.getElementById('id_cpa57')).trigger('input').trigger('change'); $(document.getElementById('nom_prov')).trigger('input').trigger('change');
      }
    });

    // Llamar a cargarDatos al final para asegurar que todo el DOM esté listo y los listeners adjuntos.
    cargarDatos();// CORRECCIÓN: Mover el listener de .file-input DENTRO del $(document).ready()
    // para que tenga acceso a 'documentosRequeridosIds' y 'actualizarUICardDocumento'
    // que también están definidas o se usan dentro de este scope.
    document.querySelectorAll('.file-input').forEach(input => {
      input.addEventListener('change', function() { 
        const fileInputId = this.id;
        const fileName = this.files[0] ? this.files[0].name : null;
        const esRequerido = documentosRequeridosIds.includes(fileInputId); // Accede a la variable del scope de ready
        
        actualizarUICardDocumento(fileInputId, fileName, '#', esRequerido); // Llama a la función helper

        if (this.files[0]) { // Validaciones frontend opcionales
            const maxFileSize = 5 * 1024 * 1024; 
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (this.files[0].size > maxFileSize) {
                alert(`El archivo "${fileName}" es demasiado grande (máx. 5MB). No se subirá.`); this.value = ''; 
                actualizarUICardDocumento(fileInputId, null, '#', esRequerido); 
                return;
            }
            if (!allowedTypes.includes(this.files[0].type)) {
                alert(`Tipo de archivo no permitido para "${fileName}". Permitidos: PDF, JPG, PNG, DOC, DOCX.`); this.value = ''; 
                actualizarUICardDocumento(fileInputId, null, '#', esRequerido); 
                return;
            }
        }
      });
    });

    const contactoModal = new bootstrap.Modal(document.getElementById('contactoModal'));
  const contactoForm = document.getElementById('contactoForm');
  const mensajesStatusDiv = document.getElementById('mensajesStatus');
  const contactoFormMsgDiv = document.getElementById('contactoFormMsg');

  // // Cargar contactos cuando se muestra la pestaña de mensajes
  $('#messages-tab-btn').on('shown.bs.tab', function () {
    cargarContactos();
  });
  // Si es la pestaña activa por defecto, cárgala también al inicio
  // if ($('#messages-tab-btn').hasClass('active')) {
  //   cargarContactos();
  // }


  $('#btnNuevoContacto').on('click', function() {
    contactoForm.reset();
    // El ID del formulario modal se refiere al ID de la tabla de staging ('id')
    $('#contactoId').val(''); // Limpiar ID para modo "nuevo"
    $('#contactoModalLabel').text('Agregar Nuevo Contacto');
    contactoForm.classList.remove('was-validated');
    contactoFormMsgDiv.classList.add('d-none');
    contactoModal.show();
  });

  async function cargarContactos() {
    const tablaBody = $('#tablaContactosBody');
    tablaBody.html('<tr><td colspan="8" class="text-center">Cargando contactos...</td></tr>');
    const JW_TOKEN = sessionStorage.getItem('jwt');
    if (!JW_TOKEN) {
      tablaBody.html('<tr><td colspan="8" class="text-center text-danger">Error de autenticación.</td></tr>');
      return;
    }

    try {
      const response = await fetch('/Proveedores/api/proveedor-contactos/', { // Endpoint no cambia
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + JW_TOKEN,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
      }
      const contactos = await response.json();
      renderContactos(contactos);
    } catch (error) {
      console.error('Error al cargar contactos:', error);
      tablaBody.html(`<tr><td colspan="8" class="text-center text-danger">Error al cargar contactos: ${error.message}</td></tr>`);
      mostrarMensajeGlobal(mensajesStatusDiv, 'Error al cargar contactos.', 'danger');
    }
  }

  function renderContactos(contactos) {
    const tablaBody = $('#tablaContactosBody');
    tablaBody.empty();

    if (contactos.length === 0) {
      tablaBody.html('<tr><td colspan="8" class="text-center">No hay contactos registrados.</td></tr>');
      return;
    }

    contactos.forEach(contacto => {
      // CAMBIO: Usar contacto.id para los data-id
      const row = `
        <tr>
          <td>${escapeHtml(contacto.nombre || '')}</td>
          <td>${escapeHtml(contacto.cargo || '')}</td>
          <td>${escapeHtml(contacto.email || '')}</td>
          <td>${escapeHtml(contacto.telefono || '')}</td>
          <td>${contacto.defecto === 'S' ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>'}</td>
          <td>${contacto.envia_pdf_oc === 'S' ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>'}</td>
          <td>${contacto.envia_pdf_op === 'S' ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary btn-editar-contacto" data-id="${contacto.id}" title="Editar">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-eliminar-contacto" data-id="${contacto.id}" title="Eliminar">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.024l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m3.5-.058a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5.5a.5.5 0 0 0-.5-.5m3.5 0a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5.5a.5.5 0 0 0-.5-.5"/></svg>
            </button>
          </td>
        </tr>
      `;
      tablaBody.append(row);
    });

    // Adjuntar eventos a los nuevos botones
    $('.btn-editar-contacto').on('click', function() {
      const contactoId = $(this).data('id'); // Esto ahora es el 'id' de PostgreSQL
      // CAMBIO: Buscar el contacto usando 'id'
      const contactoAEditar = contactos.find(c => c.id == contactoId);
      if (contactoAEditar) {
        abrirModalEdicion(contactoAEditar);
      }
    });

    $('.btn-eliminar-contacto').on('click', function() {
      const contactoId = $(this).data('id'); // Esto ahora es el 'id' de PostgreSQL
      const contactoNombre = $(this).closest('tr').find('td:first').text();
      eliminarContacto(contactoId, contactoNombre);
    });
  }

  function abrirModalEdicion(contacto) {
    contactoForm.reset();
    contactoForm.classList.remove('was-validated');
    contactoFormMsgDiv.classList.add('d-none');

    // CAMBIO: Usar contacto.id para el input oculto del formulario
    $('#contactoId').val(contacto.id); // El ID de PostgreSQL
    $('#contactoModalLabel').text('Editar Contacto');
    
    $('#contactoNombre').val(contacto.nombre || '');
    $('#contactoCargo').val(contacto.cargo || '');
    $('#contactoTelefono').val(contacto.telefono || '');
    $('#contactoMovil').val(contacto.telefono_movil || '');
    $('#contactoEmail').val(contacto.email || '');
    $('#contactoObservaciones').val(contacto.observacion || '');

    $('#contactoDefecto').prop('checked', contacto.defecto === 'S');
    $('#contactoEnviaPdfOc').prop('checked', contacto.envia_pdf_oc === 'S');
    $('#contactoEnviaPdfOp').prop('checked', contacto.envia_pdf_op === 'S');
    
    contactoModal.show();
  }

  contactoForm.addEventListener('submit', async function(event) {
    event.preventDefault();
    event.stopPropagation();

    if (!contactoForm.checkValidity()) {
      contactoForm.classList.add('was-validated');
      return;
    }
    contactoForm.classList.add('was-validated');
    
    const JW_TOKEN = sessionStorage.getItem('jwt');
    if (!JW_TOKEN) {
        mostrarMensaje(contactoFormMsgDiv, 'Error de autenticación.', 'danger');
        return;
    }

    const contactoId = $('#contactoId').val(); // Este es el 'id' de PostgreSQL del input oculto
    const formData = {
      nombre: $('#contactoNombre').val(),
      cargo: $('#contactoCargo').val(),
      telefono: $('#contactoTelefono').val(),
      telefono_movil: $('#contactoMovil').val(),
      email: $('#contactoEmail').val(),
      observacion: $('#contactoObservaciones').val(),
      defecto: $('#contactoDefecto').is(':checked') ? 'S' : 'N',
      envia_pdf_oc: $('#contactoEnviaPdfOc').is(':checked') ? 'S' : 'N',
      envia_pdf_op: $('#contactoEnviaPdfOp').is(':checked') ? 'S' : 'N',
    };
    // No incluimos 'id_cpa_contactos_proveedor_habitual_sql' en el envío,
    // ya que el backend lo tiene como read_only y no lo espera en el POST/PUT.

    const url = contactoId ? `/Proveedores/api/proveedor-contactos/${contactoId}/` : '/Proveedores/api/proveedor-contactos/';
    const method = contactoId ? 'PUT' : 'POST';

    $('#btnGuardarContacto').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...');

    try {
      const response = await fetch(url, {
        method: method,
        headers: {
          'Authorization': 'Bearer ' + JW_TOKEN,
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
      });

      if (!response.ok) {
        const errorData = await response.json();
        let errorMsg = `Error HTTP ${response.status}: ${response.statusText}.`;
        if (errorData && typeof errorData === 'object') {
            errorMsg += " Detalles: " + Object.entries(errorData).map(([key, val]) => `${key}: ${val}`).join('; ');
        }
        throw new Error(errorMsg);
      }
      
      mostrarMensajeGlobal(mensajesStatusDiv, `Contacto ${contactoId ? 'actualizado' : 'creado'} correctamente.`, 'success');
      contactoModal.hide();
      cargarContactos();

    } catch (error) {
      console.error('Error al guardar contacto:', error);
      mostrarMensaje(contactoFormMsgDiv, `Error al guardar: ${error.message}`, 'danger');
    } finally {
        $('#btnGuardarContacto').prop('disabled', false).text('Guardar Contacto');
    }
  });

  async function eliminarContacto(contactoId, contactoNombre) { // contactoId es el 'id' de PostgreSQL
    if (!confirm(`¿Está seguro de que desea eliminar el contacto "${escapeHtml(contactoNombre)}"?`)) {
      return;
    }

    const JW_TOKEN = sessionStorage.getItem('jwt');
    if (!JW_TOKEN) {
        mostrarMensajeGlobal(mensajesStatusDiv, 'Error de autenticación.', 'danger');
        return;
    }

    try {
      // La URL usa el 'id' de PostgreSQL
      const response = await fetch(`/Proveedores/api/proveedor-contactos/${contactoId}/`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + JW_TOKEN,
          'X-CSRFToken': getCookie('csrftoken')
        }
      });

      if (!response.ok) {
        if (response.status !== 204) {
            const errorData = await response.text();
            throw new Error(`Error HTTP ${response.status}: ${errorData || response.statusText}`);
        }
      }
      
      mostrarMensajeGlobal(mensajesStatusDiv, 'Contacto eliminado correctamente.', 'success');
      cargarContactos();

    } catch (error) {
      console.error('Error al eliminar contacto:', error);
      mostrarMensajeGlobal(mensajesStatusDiv, `Error al eliminar: ${error.message}`, 'danger');
    }
  }
  
  // --- Funciones auxiliares (mostrarMensaje, mostrarMensajeGlobal, escapeHtml, getCookie) ---
  // ... (deben estar definidas como antes) ...
  function mostrarMensaje(divElement, mensaje, tipo = 'info') { // Muestra mensaje dentro del modal o form
    divElement.textContent = mensaje;
    divElement.className = `alert alert-${tipo}`; // Reemplaza clases
    divElement.classList.remove('d-none');
  }

  function mostrarMensajeGlobal(divElement, mensaje, tipo = 'info') { // Muestra mensaje en la pestaña
    divElement.textContent = mensaje;
    divElement.className = `alert alert-${tipo} mt-3 mb-3`;
    divElement.classList.remove('d-none');
    setTimeout(() => { // Ocultar después de unos segundos
        divElement.classList.add('d-none');
    }, 5000);
  }
  
  function escapeHtml(unsafe) {
    if (unsafe === null || typeof unsafe === 'undefined') return '';
    return String(unsafe)
         .replace(/&/g, "&")
         .replace(/</g, "<")
         .replace(/>/g, ">")
         .replace(/"/g, "''")
         .replace(/'/g, "'");
  }

  }); // Fin de $(document).ready()

  // Funciones globales (o que necesitan serlo)
  function logout() { sessionStorage.removeItem('jwt'); window.location.href = '/Proveedores/acceder/'; }
  function goToDashboard() { window.location.href = '/Proveedores/dashboard/'; }
  function triggerUpload(fileInputId) { document.getElementById(fileInputId).click(); }
  
  function viewDocument(path) { 
    if (path && path !== '#' && !path.startsWith('blob:')) { // No intentar abrir URLs blob directamente así si son locales
        window.open(path, '_blank'); 
    } else if (path && path.startsWith('blob:')) {
        // Para blobs (previsualización local), el usuario ya lo "vio" al seleccionarlo.
        // O podrías intentar mostrarlo en un modal si es una imagen.
        // Por ahora, solo no hacemos nada o un alert.
        alert('El archivo está seleccionado localmente. Se enviará al guardar.');
    }
    else { 
        alert('El documento aún no ha sido cargado o no hay una URL válida. Intente guardar los cambios primero.');
    }
  }
  </script>
</body>
</html>