<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Mis Datos de Proveedor</title>
  <style>
    .required-label::after {
      content: " *";
      color: red;
    }
    .btn-save {
      display: none;
    }
    .card-header-tabs {
      margin-bottom: -0.75rem; 
    }
    #provinciaList .list-group-item {
      cursor: pointer;
    }
    .document-card {
      border: 1px solid #dee2e6; 
      border-radius: 0.375rem; 
      background-color: #fff;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); 
      display: flex;
      flex-direction: column;
      height: 100%; 
    }
    .document-card-body {
      padding: 1.25rem;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between; 
      flex-grow: 1; 
    }
    .document-icon-area {
      font-size: 2rem; 
      margin-bottom: 0.75rem;
    }
    .document-title {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #333;
    }
    .required-asterisk {
      color: var(--bs-danger, #dc3545); 
      font-weight: bold;
    }
    .document-status-text {
      font-size: 0.8rem;
      color: #6c757d; 
      margin-bottom: 1rem;
      min-height: 30px; 
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%; 
      padding: 0.5rem 0.75rem;
    }
    .action-btn svg {
        vertical-align: middle;
    }
    .document-card.status-present {
      border-left: 5px solid var(--bs-success, #198754); 
    }
    .document-card.status-present .status-icon {
      color: var(--bs-success, #198754);
    }
    .document-card.status-required-missing {
      border-left: 5px solid var(--bs-danger, #dc3545); 
    }
    .document-card.status-required-missing .status-icon {
      color: var(--bs-danger, #dc3545);
    }
    .document-card.status-required-missing .document-title .required-asterisk {
      animation: pulse-danger 2s infinite; 
    }
    .document-card.status-optional-missing {
      border-left: 5px solid var(--bs-secondary, #6c757d); 
    }
    .document-card.status-optional-missing .status-icon {
      color: var(--bs-secondary, #6c757d);
    }
    .document-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    @keyframes pulse-danger {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .file-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2 class="mb-3">Mis Datos de Proveedor</h2>
    <div class="card card-primary card-outline card-outline-tabs">
      <div class="card-header border-bottom-0">
        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="home-tab-btn" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Home</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab-btn" data-bs-toggle="tab" data-bs-target="#config-tab-pane" type="button" role="tab" aria-controls="config-tab-pane" aria-selected="false">Configuración</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="messages-tab-btn" data-bs-toggle="tab" data-bs-target="#messages-tab-pane" type="button" role="tab" aria-controls="messages-tab-pane" aria-selected="false">Mensajes</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="documents-tab-btn" data-bs-toggle="tab" data-bs-target="#documents-tab-pane" type="button" role="tab" aria-controls="documents-tab-pane" aria-selected="false">Documentos</button>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content" id="myTabContent">
          <!-- Home Tab Pane -->
          <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab-btn" tabindex="0">
            <!-- El formulario principal ahora engloba el contenido de Home y los botones de acción -->
            <form id="proveedorForm" class="mt-3" novalidate>
              <h5>Datos de empresa</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="required-label" for="nom_provee">Razón social</label>
                  <input type="text" class="form-control" id="nom_provee" name="nom_provee" required>
                  <div class="invalid-feedback" id="nom_provee-invalid"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="required-label" for="n_cuit">CUIT</label>
                  <input type="text" class="form-control" id="n_cuit" name="n_cuit" required>
                  <div class="invalid-feedback" id="n_cuit-invalid"></div>
                </div>
              </div>
              <div class="mb-3">
                <label class="required-label" for="domicilio">Domicilio</label>
                <input type="text" class="form-control" id="domicilio" name="domicilio" required>
                <div class="invalid-feedback" id="domicilio-invalid"></div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="localidad">Localidad</label>
                  <input type="text" class="form-control" id="localidad" name="localidad">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="c_postal">Código postal</label>
                  <input type="text" class="form-control" id="c_postal" name="c_postal">
                </div>
              </div>
              <div class="mb-3">
                <label for="provincia">Provincia</label>
                <input type="text" class="form-control" id="provincia" name="provincia_display" placeholder="Buscar provincia...">
                <input type="hidden" id="id_cpa57" name="id_cpa57">
                <input type="hidden" id="nom_prov" name="nom_prov">
                <div class="list-group mt-1" id="provinciaList"></div>
              </div>

              <h5 class="mt-4">Datos de contacto</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="required-label" for="telefono_1">Teléfono</label>
                  <input type="text" class="form-control" id="telefono_1" name="telefono_1" required>
                  <div class="invalid-feedback" id="telefono_1-invalid"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="telefono_2">Teléfono 2</label>
                  <input type="text" class="form-control" id="telefono_2" name="telefono_2">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="telefono_movil">Teléfono Móvil</label>
                  <input type="text" class="form-control" id="telefono_movil" name="telefono_movil">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="required-label" for="e_mail">Email</label>
                  <input type="email" class="form-control" id="e_mail" name="e_mail" required>
                  <div class="invalid-feedback" id="e_mail-invalid"></div>
                </div>
              </div>
              <div class="mb-3">
                <label for="web">Página web</label>
                <input type="text" class="form-control" id="web" name="web">
              </div>

              <h5 class="mt-4">Información comercial</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nom_fant">Nombre comercial</label>
                  <input type="text" class="form-control" id="nom_fant" name="nom_fant">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="domicilio_comercial">Domicilio comercial</label>
                  <input type="text" class="form-control" id="domicilio_comercial" name="domicilio_comercial">
                </div>
              </div>
              <div class="mb-3">
                <label for="n_iva">Actividad</label>
                <input type="text" class="form-control" id="n_iva" name="n_iva">
              </div>
              
              

              <!-- CORRECCIÓN ESTRUCTURAL: Botones de acción movidos DENTRO del proveedorForm -->
              
            </form> <!-- Fin de proveedorForm -->
          </div>

          <!-- Configuración Tab Pane -->
          <div class="tab-pane fade" id="config-tab-pane" role="tabpanel" aria-labelledby="config-tab-btn" tabindex="0">
            <h5 class="mt-3">Configuración</h5>
            <form id="configForm" class="mt-3" novalidate>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="condicionIva">Condición de IVA</label>
                  <select class="form-select" id="condicionIva" name="condicionIva"></select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="ingresosBrutos">Régimen de Ingresos Brutos</label>
                  <select class="form-select" id="ingresosBrutos" name="ingresosBrutos"></select>
                </div>
              </div>
              <div class="mb-3">
                <label for="n_ing_brut">Nro. de ingresos brutos</label>
                <input type="text" class="form-control" id="n_ing_brut" name="n_ing_brut">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cbu">Clave bancaria única (CBU)</label>
                  <input type="text" class="form-control" id="cbu" name="cbu">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="descripcion_cbu">Descripción</label>
                  <input type="text" class="form-control" id="descripcion_cbu" name="descripcion_cbu">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cbu_2">Clave bancaria única 2 (CBU)</label>
                  <input type="text" class="form-control" id="cbu_2" name="cbu_2">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="descripcion_cbu_2">Descripción</label>
                  <input type="text" class="form-control" id="descripcion_cbu_2" name="descripcion_cbu_2">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cbu_3">Clave bancaria única 3 (CBU)</label>
                  <input type="text" class="form-control" id="cbu_3" name="cbu_3">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="descripcion_cbu_3">Descripción</label>
                  <input type="text" class="form-control" id="descripcion_cbu_3" name="descripcion_cbu_3">
                </div>
              </div>
            </form>
          </div>

          <!-- Mensajes Tab Pane -->
          <div class="tab-pane fade" id="messages-tab-pane" role="tabpanel" aria-labelledby="messages-tab-btn" tabindex="0">
            <h5 class="mt-3">Mensajes</h5>
            <form id="messagesForm" class="mt-3" novalidate>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nombre">Nombre</label>
                  <input type="text" class="form-control" id="nombre" name="nombre">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="cargo">Cargo</label>
                  <input type="text" class="form-control" id="cargo" name="cargo">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="telefono">Teléfono</label>
                  <input type="text" class="form-control" id="telefono" name="telefono">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="movil">Móvil</label>
                  <input type="text" class="form-control" id="movil" name="movil">
                </div>
              </div>
              <div class="mb-3">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email">
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <!-- Contacto habitual -->
                  <div class="form-check" style="margin-top: 1.8rem;">
                    <input class="form-check-input" type="checkbox" id="contacto_habitual" name="contacto_habitual">
                    <label class="form-check-label" for="contacto_habitual">
                      Contacto habitual
                    </label>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <!-- Recibe ordenes de compra -->
                  <div class="form-check" style="margin-top: 1.8rem;">
                    <input class="form-check-input" type="checkbox" id="recibe_ordenes_compra" name="recibe_ordenes_compra">
                    <label class="form-check-label" for="recibe_ordenes_compra">
                      Recibe órdenes de compra
                    </label>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <!-- Recibe ordenes de pago -->
                  <div class="form-check" style="margin-top: 1.8rem;">
                    <input class="form-check-input" type="checkbox" id="recibe_ordenes_pago" name="recibe_ordenes_pago">
                    <label class="form-check-label" for="recibe_ordenes_pago">
                      Recibe órdenes de pago
                    </label>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="observaciones">Observaciones</label>
                <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
              </div>
            </form>
          </div>

          <!-- Documentos Tab Pane -->
          <div class="tab-pane fade" id="documents-tab-pane" role="tabpanel" aria-labelledby="documents-tab-btn" tabindex="0">
            <h5 class="mt-3 mb-4">Documentos Adjuntos</h5>
            <div class="row">
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-required-missing" id="card-cuitFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill status-icon" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                      </svg>
                    </div>
                    <h6 class="document-title">Constancia de CUIT/CUIL <span class="required-asterisk">*</span></h6>
                    <p class="document-status-text">Pendiente de carga</p>
                    <button type="button" class="btn btn-primary btn-sm action-btn" onclick="triggerUpload('cuitFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                      </svg>
                      Cargar Archivo
                    </button>
                    <input type="file" id="cuitFile" name="cuitFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-required-missing" id="card-ingBrutosFile"> <!-- Asumiendo que este es requerido -->
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill status-icon" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                      </svg>
                    </div>
                    <h6 class="document-title">Inscripción Ing. Brutos <span class="required-asterisk">*</span></h6>
                    <p class="document-status-text">Pendiente de carga</p>
                    <button type="button" class="btn btn-primary btn-sm action-btn" onclick="triggerUpload('ingBrutosFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar Archivo
                    </button>
                    <input type="file" id="ingBrutosFile" name="ingBrutosFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-optional-missing" id="card-exclGananciasFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16">
                          <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                      </svg>
                    </div>
                    <h6 class="document-title">Cert. Exclusión Ganancias</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('exclGananciasFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="exclGananciasFile" name="exclGananciasFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-optional-missing" id="card-cm05File">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Constancia CM05</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('cm05File')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="cm05File" name="cm05File" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg">
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-optional-missing" id="card-noRetGananciasFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Cert. No Ret. Ganancias</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('noRetGananciasFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="noRetGananciasFile" name="noRetGananciasFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg,.doc,.docx">
                  </div>
                </div>
              </div>

              <!-- Documento: Certificado de Exclusión de Ingresos Brutos (Opcional) -->
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-optional-missing" id="card-exclIIBBFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Cert. Exclusión IIBB</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('exclIIBBFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="exclIIBBFile" name="exclIIBBFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg,.doc,.docx">
                  </div>
                </div>
              </div>

              <!-- Documento: Certificado de No Retención de Ingresos Brutos (Opcional) -->
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="document-card status-optional-missing" id="card-noRetIIBBFile">
                  <div class="document-card-body">
                    <div class="document-icon-area">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill status-icon" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>
                    </div>
                    <h6 class="document-title">Cert. No Ret. IIBB</h6>
                    <p class="document-status-text">Opcional, no cargado</p>
                    <button type="button" class="btn btn-outline-primary btn-sm action-btn" onclick="triggerUpload('noRetIIBBFile')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                      Cargar (Opcional)
                    </button>
                    <input type="file" id="noRetIIBBFile" name="noRetIIBBFile" class="d-none file-input" accept=".pdf,.jpg,.png,.jpeg,.doc,.docx">
                  </div>
                </div>
              </div>
            </div>
            <div id="documentUploadStatus" class="mt-3"></div>
          </div> 
        </div>
      </div>
      <div class="card-footer bg-light">
        <div id="formMsg" class="alert mt-0 mb-3 d-none"></div> <!-- Mensaje global -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" onclick="goToDashboard()">Volver al Inicio</button>
          <button type="submit" class="btn btn-success btn-save" form="proveedorForm">Guardar Cambios</button>
        </div>
      </div>
    </div>
    <!-- Botón de cerrar sesión, fuera de la estructura de la tarjeta y formularios -->
    <div class="text-center">
        <button class="btn btn-outline-danger mt-4 mb-4" onclick="logout()">Cerrar sesión</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  let documentosRequeridosIds = ['cuitFile', 'ingBrutosFile']; 

  // Helper para actualizar UI de tarjeta de documento
    // Esta función debe estar definida ANTES de ser llamada en cargarDatos o en los listeners de file-input
    function actualizarUICardDocumento(fileInputId, fileName, fileUrl, esRequerido) {
        const input = document.getElementById(fileInputId);
        if (!input) { /* console.warn(`Input ${fileInputId} no encontrado para UI update`);*/ return; }
        const cardBody = input.closest('.document-card-body');
        if (!cardBody) { /* console.warn(`Card body para ${fileInputId} no encontrado`);*/ return; }

        const statusTextElement = cardBody.querySelector('.document-status-text');
        const actionButton = cardBody.querySelector('.action-btn');
        const documentCard = input.closest('.document-card');
        const statusIconArea = cardBody.querySelector('.document-icon-area');

        if(!statusTextElement || !actionButton || !documentCard || !statusIconArea) {
            // console.warn(`Uno o más elementos UI no encontrados para la tarjeta ${fileInputId}`);
            return;
        }

        documentCard.classList.remove('border', 'border-danger'); 

        if (fileName && fileUrl) { 
            statusTextElement.textContent = 'Archivo cargado: ' + fileName;
            actionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill me-1" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/></svg> Ver Documento`;
            actionButton.onclick = () => viewDocument(fileUrl);
            actionButton.classList.remove('btn-primary', 'btn-outline-primary'); actionButton.classList.add('btn-outline-secondary');
            documentCard.classList.remove('status-required-missing', 'status-optional-missing'); documentCard.classList.add('status-present');
            statusIconArea.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill status-icon" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>`;
        } else { 
            statusTextElement.textContent = esRequerido ? 'Pendiente de carga' : 'Opcional, no cargado';
            actionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg> ${esRequerido ? 'Cargar Archivo' : 'Cargar (Opcional)'}`;
            actionButton.onclick = () => triggerUpload(fileInputId);
            actionButton.classList.remove('btn-outline-secondary'); actionButton.classList.add(esRequerido ? 'btn-primary' : 'btn-outline-primary');
            documentCard.classList.remove('status-present'); documentCard.classList.add(esRequerido ? 'status-required-missing' : 'status-optional-missing');
            const iconClass = esRequerido ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';
            const iconPath = esRequerido ? "M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2" : "M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2";
            statusIconArea.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi ${iconClass} status-icon" viewBox="0 0 16 16"><path d="${iconPath}"/></svg>`;
        }
    }
  
  $(document).ready(function() {
    // const jwt = sessionStorage.getItem('jwt'); // Se obtiene dentro de obtenerUserId
    // if (!jwt) { // Esta verificación también se hace en obtenerUserId
    //   window.location.href = '/Proveedores/acceder/';
    //   return; 
    // }

    let proveedorId = null;
    let userId = null;
    let codCpa01Value = null;
    let initialData = {}; 
    let codPais = null;

    const camposPrincipalesEditables = [ 
      { key: "nom_provee", label: "Razon social" }, { key: "n_cuit", label: "CUIT" },
      { key: "domicilio", label: "Domicilio" }, { key: "localidad", label: "Localidad" },
      { key: "c_postal", label: "Código postal" }, { key: "telefono_1", label: "Teléfono" },
      { key: "telefono_2", label: "Teléfono 2" }, { key: "telefono_movil", label: "Teléfono móvil" },
      { key: "e_mail", label: "Email" }, { key: "web", label: "Pagina Web" },
      { key: "nom_fant", label: "Nombre comercial" }, { key: "domicilio_comercial", label: "Domicilio comercial" },
      { key: "n_iva", label: "Actividad" }, { key: "n_ing_brut", label: "Nro. de ingresos brutos" },
      { key: "cbu", label: "Clave bancaria única (CBU)" }, { key: "descripcion_cbu", label: "Descripción" },
      { key: "cbu_2", label: "Clave bancaria única 2 (CBU)" }, { key: "descripcion_cbu_2", label: "Descripción" },
      { key: "cbu_3", label: "Clave bancaria única 3 (CBU)" }, { key: "descripcion_cbu_3", label: "Descripción" },
    ];
    const camposContactoObligatorios = ["nom_provee", "n_cuit", "telefono_1", "e_mail", "domicilio"];
    
    const camposBloquear = ["nom_provee","nom_fant","n_cuit"];

    

    async function obtenerUserId() {
      const JW_TOKEN = sessionStorage.getItem('jwt');
      if (!JW_TOKEN) {
          console.warn('No se encontró JWT en sessionStorage. Redirigiendo a la página de acceso.');
          window.location.href = '/Proveedores/acceder/';
          return null; 
      }
      try {
        const resp = await fetch('/Proveedores/api/userid/', { headers: { 'Authorization': 'Bearer ' + JW_TOKEN }});
        if (!resp.ok) {
          console.error(`Error al obtener User ID. Estado: ${resp.status}, Texto: ${resp.statusText}`);
          if (resp.status === 401 || resp.status === 403) {
            console.log('Error de autenticación (401/403). Limpiando JWT y redirigiendo a la página de acceso.');
            sessionStorage.removeItem('jwt');
            window.location.href = '/Proveedores/acceder/';
          }
          return null;
        }
        const data = await resp.json();
        if (!data || data.user_id === undefined) {
            console.error('User ID no encontrado en la respuesta de /api/userid/. Respuesta:', data);
            return null;
        }
        console.log('User ID obtenido:', data.user_id);
        return data.user_id;
      } catch (error) { 
        console.error('Error de red durante la obtención de User ID (/api/userid/):', error);
        sessionStorage.removeItem('jwt'); 
        window.location.href = '/Proveedores/acceder/'; 
        return null;
      }
    }

    async function cargarDatos() {
      userId = await obtenerUserId();
      const msgDivCarga = $('#formMsg');

      if (!userId) {
        msgDivCarga.text('No se pudo verificar el usuario. Redirigiendo a la página de acceso...')
                   .removeClass('d-none alert-success alert-info')
                   .addClass('alert-danger');
        if (!window.location.href.endsWith('/Proveedores/acceder/')) { 
            setTimeout(() => {
                if (!sessionStorage.getItem('jwt')) { 
                     window.location.href = '/Proveedores/acceder/';
                } else {
                    console.error("UserID es null, pero el token JWT aún existe. Podría ser un error temporal del API /api/userid/.");
                    msgDivCarga.text('Hubo un problema al obtener los datos del usuario. Por favor, intente recargar la página o contacte a soporte si el problema persiste.');
                }
            }, 2500);
        }
        return; 
      }
      msgDivCarga.addClass('d-none').removeClass('alert-danger alert-info');

      let proveedor = {};
      try {
        const resp = await fetch('/Proveedores/api/proveedores/' + userId + '/', { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (!resp.ok) {
          if (resp.status === 404) { 
            console.warn('No se encontraron datos de proveedor para el usuario. Se puede completar el formulario.');
          } else { 
            console.error('Error al cargar datos del proveedor: ' + resp.statusText, resp.status); 
            msgDivCarga.text(`Error al cargar datos del proveedor (${resp.status}). Por favor, intente más tarde.`)
                      .removeClass('d-none').addClass('alert-danger');
          }
        } else {
            proveedor = await resp.json(); 
            proveedorId = proveedor.id; 
            codCpa01Value = proveedor.cod_cpa01; 
            codPais = proveedor.cod_pais;
            console.log('Datos del proveedor cargados:', proveedor);
        }

        camposPrincipalesEditables.forEach(campo => {
          const inputElement = document.getElementById(campo.key);
          if (inputElement) {
            const value = proveedor[campo.key]; inputElement.value = (value !== null && value !== undefined) ? value : '';
            initialData[campo.key] = inputElement.value; 
            if (codCpa01Value && codCpa01Value.trim() !== "" && camposBloquear.includes(campo.key)) { inputElement.disabled = true; }
          }
        });
        
        const provinciaDisplayInput = document.getElementById('provincia');
        const idCpa57Input = document.getElementById('id_cpa57');
        const nomProvInput = document.getElementById('nom_prov');
        provinciaDisplayInput.value = proveedor.nom_prov || ''; 
        idCpa57Input.value = proveedor.id_cpa57 || ''; 
        nomProvInput.value = proveedor.nom_prov || '';
        initialData[provinciaDisplayInput.name || provinciaDisplayInput.id] = provinciaDisplayInput.value; 
        initialData[idCpa57Input.name || idCpa57Input.id] = idCpa57Input.value; 
        initialData[nomProvInput.name || nomProvInput.id] = nomProvInput.value;

        if (codPais) { await cambiarConexion(codPais); } 

        await cargarCondicionIva(proveedor.id_categoria_iva_cond_iva);
        initialData['condicionIva'] = document.getElementById('condicionIva').value;
        
        await cargarIngresosBrutos(proveedor.tipo);
        initialData['ingresosBrutos'] = document.getElementById('ingresosBrutos').value;
        
        const messagesFormElements = document.querySelectorAll('#messagesForm input, #messagesForm select, #messagesForm textarea');
        messagesFormElements.forEach(el => {
            if (el.name || el.id) {
                const key = el.name || el.id;
                const value = proveedor[key];

                if (el.type === 'checkbox' && (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago')) {
                    el.checked = (value === 'S'); // Marcar si el valor es "S"
                    initialData[key] = el.checked ? 'S' : 'N'; // Guardar 'S' o 'N' en initialData
                } else if (el.tagName.toLowerCase() === 'select') {
                    el.value = (value !== null && value !== undefined) ? String(value) : (el.options.length > 0 ? el.options[0].value : '');
                    initialData[key] = el.value;
                } else { // Para inputs de texto, email, textarea, etc.
                    el.value = (value !== null && value !== undefined) ? value : '';
                    initialData[key] = el.value;
                }
            }
        });

        const fileInputsDocumentos = document.querySelectorAll('#documents-tab-pane .file-input');
        fileInputsDocumentos.forEach(input => {
            if (input.id) {
                const fileInfo = proveedor.documentos_data ? proveedor.documentos_data[input.id] : null;
                const esRequerido = documentosRequeridosIds.includes(input.id);
                if (fileInfo && fileInfo.name) {
                    initialData[input.id] = fileInfo.name;
                    actualizarUICardDocumento(input.id, fileInfo.name, fileInfo.url, esRequerido);
                } else {
                    initialData[input.id] = '';
                    actualizarUICardDocumento(input.id, null, null, esRequerido);
                }
            }
        });

        agregarValidacionCuitFrontend();
        monitorChanges(); 
      } catch (error) {
        console.error('Error al procesar los datos del proveedor o al cargar componentes:', error);
        msgDivCarga.text('Ocurrió un error al cargar la información de la página. Intente recargar.')
                   .removeClass('d-none').addClass('alert-danger');
        monitorChanges(); 
        agregarValidacionCuitFrontend();
      }
    }

    async function cargarCondicionIva(selectedId) {
      const select = document.getElementById('condicionIva');
      select.innerHTML = '<option value="">Seleccione...</option>';
      try {
        const resp = await fetch('/Proveedores/api/categoria-iva/', { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (resp.ok) {
          const categorias = await resp.json();
          categorias.forEach(cat => { 
            const option = document.createElement('option'); option.value = cat.id_categoria_iva; 
            option.textContent = cat.desc_categoria_iva; option.setAttribute('data-cod', cat.cod_categoria_iva); 
            select.appendChild(option); 
          });
          console.log('Condiciones de IVA cargadas.');
        } else { 
          console.error("Error cargando Condicion IVA:", resp.statusText, resp.status); 
        }
        let valorASeleccionar = ""; 
        if (selectedId !== null && selectedId !== undefined && String(selectedId).trim() !== "") {
            if (Array.from(select.options).some(opt => opt.value == String(selectedId))) {
                valorASeleccionar = String(selectedId);
            } else {
                console.warn(`Opción con valor "${selectedId}" no encontrada en Condicion IVA. Se usará el valor por defecto.`);
            }
        }
        select.value = valorASeleccionar;
      } catch (error) { 
        console.error("Network error cargando Condicion IVA:", error); 
        select.value = ""; 
      }
    }

    async function cargarIngresosBrutos(selectedTipo) {
      const select = document.getElementById('ingresosBrutos');
      select.innerHTML = '<option value="">Seleccione...</option>';
       try {
        const resp = await fetch('/Proveedores/api/ingresos-brutos/', { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (resp.ok) {
          const ingresosBrutos = await resp.json();
          ingresosBrutos.forEach(ib => { 
            const option = document.createElement('option'); option.value = ib.Cod_Ingresos_brutos; 
            option.textContent = ib.Desc_Ingresos_brutos; select.appendChild(option); 
          });
          console.log('Regímenes de Ingresos Brutos cargados.');
        } else { 
          console.error("Error cargando Ingresos Brutos:", resp.statusText, resp.status); 
        }
        let valorASeleccionar = ""; 
        if (selectedTipo !== null && selectedTipo !== undefined && String(selectedTipo).trim() !== "") {
            if (Array.from(select.options).some(opt => opt.value == String(selectedTipo))) {
                valorASeleccionar = String(selectedTipo);
            } else {
                console.warn(`Opción con valor "${selectedTipo}" no encontrada en Ingresos Brutos. Se usará el valor por defecto.`);
            }
        }
        select.value = valorASeleccionar;
      } catch (error) { 
        console.error("Network error cargando Ingresos Brutos:", error); 
        select.value = ""; 
      }
    }

    async function cambiarConexion(pais) {
        if (!pais) return;
        try {
            const resp = await fetch('/Proveedores/api/cambiar-conexion/', { 
                method: 'POST', 
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') 
                }, 
                body: JSON.stringify({ cod_pais: pais }) 
            });
            if (!resp.ok) { 
                console.error('Error al cambiar la conexión de país:', await resp.text()); 
            } else {
                console.log('Conexión de país cambiada a:', pais);
            }
        } catch (error) { 
            console.error('Network error al cambiar la conexión de país:', error); 
        }
    }
    
    function monitorChanges() {
      const inputs = document.querySelectorAll(
        '#proveedorForm input, #proveedorForm select, #proveedorForm textarea, ' +
        '#configForm input, #configForm select, #configForm textarea, ' +
        '#messagesForm input, #messagesForm select, #messagesForm textarea, ' + 
        '#documents-tab-pane .file-input' 
      );
      const saveButton = document.querySelector('.btn-save');
      const checkChanges = () => {
        let hasChanges = false;
        inputs.forEach(input => {
          const key = input.name || input.id;
          const dataKey = (input.id === 'provincia' && initialData.hasOwnProperty('provincia')) ? 'provincia' : key;
          if (input.type === 'file') {
            if (input.files && input.files.length > 0) {
              const currentFileName = input.files[0].name;
              const initialFileName = initialData[key] || '';
              if (currentFileName !== initialFileName) { hasChanges = true; }
            }
            // Considerar si un archivo fue removido como un cambio
            // else if (initialData[key] && initialData[key] !== '') { // Si había un archivo antes y ahora no hay ninguno seleccionado
            //    hasChanges = true; // Esto es un cambio (archivo borrado)
            // }
          } else {
            const key = input.name || input.id; // Asegúrate que 'key' esté definida aquí
            const dataKey = (input.id === 'provincia' && initialData.hasOwnProperty('provincia')) ? 'provincia' : key;

            if (input.type === 'file') {
              if (input.files && input.files.length > 0) {
                const currentFileName = input.files[0].name;
                const initialFileName = initialData[key] || '';
                if (currentFileName !== initialFileName) { hasChanges = true; }
              }
              // Considerar si un archivo fue removido como un cambio (opcional)
            } else if (input.type === 'checkbox' && (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago')) {
              const currentValue = input.checked ? 'S' : 'N';
              const initialValue = initialData[key] !== undefined ? String(initialData[key]) : 'N'; // Default a 'N' si no hay dato inicial
              if (currentValue !== initialValue) {
                  hasChanges = true;
              }
            } else { // Para otros inputs (texto, selects, otros checkboxes)
              const currentValue = (input.type === 'checkbox') ? input.checked.toString() : input.value;
              const initialValue = initialData[dataKey] !== undefined ? String(initialData[dataKey]) : '';
              if (String(currentValue) !== initialValue) {
                  hasChanges = true;
              }
            }
          }
        });
        saveButton.style.display = hasChanges ? 'block' : 'none';
      };
      inputs.forEach(input => {
        if (input.type === 'file' || input.tagName.toLowerCase() === 'select' || input.type === 'checkbox' || input.type === 'radio') {
            input.addEventListener('change', checkChanges);
        } else {
            input.addEventListener('input', checkChanges); input.addEventListener('change', checkChanges); 
        }
      });
    }

    function gatherFormDataFromAllTabs() { 
        const formData = new FormData(); 
        const formsToProcess = ['#proveedorForm', '#configForm', '#messagesForm'];
        formsToProcess.forEach(formSelector => {
            const formElements = document.querySelectorAll(`${formSelector} input:not([type="file"]), ${formSelector} select, ${formSelector} textarea`);
            formElements.forEach(el => {
                if ((el.name || el.id) && !el.disabled) {
                    const key = el.name || el.id;
                    if (el.type === 'checkbox' && (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago')) {
                        formData.append(key, el.checked ? 'S' : 'N'); // Enviar 'S' si está marcado, 'N' si no
                    } else if (el.type === 'checkbox') { // Para otros checkboxes (si los hubiera)
                        formData.append(key, el.checked);
                    } else if (el.type === 'radio') {
                        if (el.checked) { formData.append(key, el.value.trim() === "" ? '' : el.value.trim()); }
                    } else { // Para inputs de texto, selects, textareas
                        formData.append(key, el.value.trim() === "" ? '' : el.value.trim());
                    }
                }
            });
        });
        if (formData.has('provincia_display')) { formData.delete('provincia_display'); } // provincia_display es el input visible
        const idCpa57Val = document.getElementById('id_cpa57').value; const nomProvVal = document.getElementById('nom_prov').value;
        formData.set('id_cpa57', idCpa57Val || ''); formData.set('nom_prov', nomProvVal || '');
        formData.set('id_categoria_iva_cond_iva', document.getElementById('condicionIva').value || '');
        if (formData.has('condicionIva')) formData.delete('condicionIva');
        formData.set('tipo', document.getElementById('ingresosBrutos').value || '');
        if (formData.has('ingresosBrutos')) formData.delete('ingresosBrutos');
        const fileInputsDocumentos = document.querySelectorAll('#documents-tab-pane .file-input');
        fileInputsDocumentos.forEach(input => {
            if (input.id && input.files && input.files.length > 0) {
                formData.append(input.id, input.files[0], input.files[0].name); 
            }
        });
        return formData;
    }

    document.getElementById('proveedorForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      let valido = true; let mensajes = [];
      camposContactoObligatorios.forEach(campoKey => {
          const input = document.getElementById(campoKey);
          if (input && input.value.trim() === "") {
              valido = false; const labelText = input.previousElementSibling?.textContent.replace('*', '').trim() || campoKey;
              mensajes.push(`El campo "${labelText}" (pestaña Home) es obligatorio.`); input.classList.add('is-invalid');
              const feedbackEl = document.getElementById(`${campoKey}-invalid`); if (feedbackEl) feedbackEl.textContent = `Este campo es obligatorio.`;
          } else if (input) { input.classList.remove('is-invalid'); const feedbackEl = document.getElementById(`${campoKey}-invalid`); if (feedbackEl) feedbackEl.textContent = "";}
      });
      const cuitInputHTML = document.getElementById('n_cuit');
      if (cuitInputHTML && cuitInputHTML.value.trim() !== "") {
          const cuitPattern = /^\d{2}-\d{8}-\d{1}$/;
          if (!cuitPattern.test(cuitInputHTML.value.trim())) {
              valido = false; mensajes.push('El CUIT (pestaña Home) debe tener el formato XX-XXXXXXXX-X.');
              cuitInputHTML.classList.add('is-invalid'); const feedbackEl = document.getElementById('n_cuit-invalid'); if (feedbackEl) feedbackEl.textContent = 'Formato inválido. Ejemplo: 20-31441849-3';
          } else { if (cuitInputHTML.classList.contains('is-invalid')) { cuitInputHTML.classList.remove('is-invalid'); const feedbackEl = document.getElementById('n_cuit-invalid'); if (feedbackEl) feedbackEl.textContent = "";}}
      }
      let primerDocumentoFaltante = null;
      documentosRequeridosIds.forEach(fileInputId => {
          const fileInput = document.getElementById(fileInputId); const documentCard = document.getElementById(`card-${fileInputId}`);
          const documentTitleElement = documentCard ? documentCard.querySelector('.document-title') : null;
          const documentName = documentTitleElement ? documentTitleElement.textContent.replace('*','').trim() : `Documento ${fileInputId}`;
          const yaCargadoPreviamenteConNombre = initialData[fileInputId] && initialData[fileInputId] !== '';
          const nuevoArchivoSeleccionado = fileInput && fileInput.files && fileInput.files.length > 0;
          if (!nuevoArchivoSeleccionado && !yaCargadoPreviamenteConNombre) {
              valido = false; mensajes.push(`El documento "${documentName}" (pestaña Documentos) es requerido.`);
              if (documentCard) { documentCard.classList.add('border', 'border-danger'); }
              if (!primerDocumentoFaltante) { primerDocumentoFaltante = fileInputId; }
          } else if (documentCard) { documentCard.classList.remove('border', 'border-danger'); }
      });
      const msgDiv = document.getElementById('formMsg');
      if (!valido) {
          msgDiv.innerHTML = mensajes.join('<br>'); msgDiv.className = 'alert alert-danger mt-0 mb-3'; msgDiv.classList.remove('d-none');
          if (primerDocumentoFaltante && !mensajes.some(m => m.includes("pestaña Home"))) { 
              const documentsTabButton = document.getElementById('documents-tab-btn');
              if (documentsTabButton) { new bootstrap.Tab(documentsTabButton).show(); }
          } return; 
      } else { msgDiv.classList.add('d-none'); msgDiv.textContent = '';}
      const formDataToSave = gatherFormDataFromAllTabs(); const method = proveedorId ? 'PATCH' : 'POST';
      let url = proveedorId ? `/Proveedores/api/proveedores/${proveedorId}/` : `/Proveedores/api/proveedores/`;
      if (method === 'POST') { if (userId) formDataToSave.append('user', userId); if (codPais) formDataToSave.append('cod_pais', codPais); }
      msgDiv.textContent = 'Guardando datos...'; msgDiv.className = 'alert alert-info mt-0 mb-3'; msgDiv.classList.remove('d-none');
      document.querySelector('.btn-save').disabled = true;
      try {
        const resp = await fetch(url, { method: method, headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt'), 'X-CSRFToken': getCookie('csrftoken') }, body: formDataToSave });
        if (resp.ok) {
          const responseData = await resp.json(); 
          if (method === 'POST' && responseData.id) {
            proveedorId = responseData.id; 
            if (responseData.cod_cpa01) { codCpa01Value = responseData.cod_cpa01; camposBloquear.forEach(keyToBlock => { const inputToBlock = document.getElementById(keyToBlock); if (inputToBlock && codCpa01Value && codCpa01Value.trim() !== "") { inputToBlock.disabled = true; }});}
            if (responseData.cod_pais) { codPais = responseData.cod_pais; }
          }
          for (const [key, value] of formDataToSave.entries()) { 
            if (value instanceof File) continue; 

            if (key === 'id_categoria_iva_cond_iva') { 
                initialData['condicionIva'] = String(value);
            } else if (key === 'tipo') { 
                initialData['ingresosBrutos'] = String(value);
            } else if (key === 'id_cpa57') { 
                initialData['id_cpa57'] = String(value); 
            } else if (key === 'nom_prov') { 
                initialData['nom_prov'] = String(value); 
            } else if (key === 'contacto_habitual' || key === 'recibe_ordenes_compra' || key === 'recibe_ordenes_pago') {
                initialData[key] = String(value); // 'value' ya es 'S' o 'N' desde formDataToSave
            } else if (initialData.hasOwnProperty(key)) { // Para todos los demás campos que estaban en initialData
                initialData[key] = value === null ? '' : String(value);
            }
          }
          initialData[document.getElementById('provincia').name || document.getElementById('provincia').id] = formDataToSave.get('nom_prov') || '';

          const fileInputs = document.querySelectorAll('#documents-tab-pane .file-input');
          fileInputs.forEach(input => {
            if (input.id) {
                const docDataFromServer = responseData.documentos_data ? responseData.documentos_data[input.id] : null;
                const esRequerido = documentosRequeridosIds.includes(input.id);
                if (docDataFromServer && docDataFromServer.name) {
                    initialData[input.id] = docDataFromServer.name;
                    actualizarUICardDocumento(input.id, docDataFromServer.name, docDataFromServer.url, esRequerido);
                } else {
                    const fileSent = formDataToSave.get(input.id); 
                    if (fileSent instanceof File) { initialData[input.id] = fileSent.name; } 
                    else if (!initialData[input.id] && !docDataFromServer) { initialData[input.id] = ''; actualizarUICardDocumento(input.id, null, null, esRequerido); }
                }
                input.value = ''; 
            }
          });
          msgDiv.textContent = 'Datos actualizados correctamente.'; msgDiv.className = 'alert alert-success mt-0 mb-3'; msgDiv.classList.remove('d-none');
          document.querySelector('.btn-save').style.display = 'none'; 
        } else { 
          const errText = await resp.text(); let err; try { err = JSON.parse(errText); } catch (e) { err = errText; }
          let errorMessages = 'Error al guardar los datos.';
          if (typeof err === 'object' && err !== null) { errorMessages = Object.entries(err).map(([key, value]) => { const fieldLabel = camposPrincipalesEditables.find(c => c.key === key)?.label || document.querySelector(`label[for="${key}"]`)?.textContent.replace('*', '').trim() || key; return `${fieldLabel}: ${Array.isArray(value) ? value.join(', ') : value}`; }).join('<br>');
          } else if (typeof err === 'string') { errorMessages = err; }
          msgDiv.innerHTML = errorMessages; msgDiv.className = 'alert alert-danger mt-0 mb-3'; msgDiv.classList.remove('d-none');
        }
      } catch (error) { 
        console.error("Error durante el guardado:", error); msgDiv.textContent = 'Error de red o problema al procesar la solicitud de guardado.';
        msgDiv.className = 'alert alert-danger mt-0 mb-3'; msgDiv.classList.remove('d-none');
      } finally { document.querySelector('.btn-save').disabled = false; }
  });

    function agregarValidacionCuitFrontend() {
      const cuitInput = document.getElementById('n_cuit');
      if (cuitInput) {
        cuitInput.addEventListener('input', function() {
          const cuitPattern = /^\d{2}-\d{8}-\d{1}$/; const feedbackEl = document.getElementById('n_cuit-invalid');
          if (cuitInput.value.trim() !== "" && !cuitPattern.test(cuitInput.value.trim())) { cuitInput.classList.add('is-invalid'); if (feedbackEl) feedbackEl.textContent = 'Formato inválido. Ejemplo: 20-31441849-3';
          } else { cuitInput.classList.remove('is-invalid'); if (feedbackEl) feedbackEl.textContent = ""; }
        });
      }
    }
    
    function getCookie(name) {
        let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; }}} return cookieValue;
    }

    document.getElementById('provincia').addEventListener('input', async function() {
      const query = this.value; const provinciaListDiv = document.getElementById('provinciaList');
      if (query.length < 2) { provinciaListDiv.innerHTML = ''; return; }
      if (!codPais && proveedorId) { // Si no hay codPais pero sí proveedor, intentar obtenerlo o usar default
        console.warn("Código de país (codPais) no establecido globalmente. Intentando usar el del proveedor o AR por defecto para búsqueda de provincia.");
        // Podrías hacer un fetch aquí para obtener codPais del proveedor si no se cargó inicialmente
        // o simplemente asumir 'AR' si es el más común.
      }
      const paisParaQuery = codPais || 'AR'; // Usar AR como fallback si codPais no está
      try {
        const resp = await fetch(`/Proveedores/api/provincias/?q=${encodeURIComponent(query)}&cod_pais=${paisParaQuery}`, { headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwt') }});
        if (resp.ok) { const provincias = await resp.json(); const list = provincias.map(p => `<button type="button" class="list-group-item list-group-item-action" data-id="${p.id}" data-nom="${p.display}">${p.display}</button>`).join(''); provinciaListDiv.innerHTML = list;
        } else { console.error("Error buscando provincias:", resp.statusText); provinciaListDiv.innerHTML = '<div class="list-group-item text-danger">Error al buscar</div>'; }
      } catch (error) { console.error("Network error buscando provincias:", error); provinciaListDiv.innerHTML = '<div class="list-group-item text-danger">Error de red</div>';}
    });

    document.getElementById('provinciaList').addEventListener('click', function(e) {
      if (e.target && e.target.matches('button.list-group-item')) {
        const selectedText = e.target.textContent; const selectedId = e.target.getAttribute('data-id'); const selectedNom = e.target.getAttribute('data-nom'); 
        const provinciaInput = document.getElementById('provincia'); provinciaInput.value = selectedText;
        document.getElementById('id_cpa57').value = selectedId; document.getElementById('nom_prov').value = selectedNom; 
        document.getElementById('provinciaList').innerHTML = ''; 
        $(provinciaInput).trigger('input').trigger('change'); $(document.getElementById('id_cpa57')).trigger('input').trigger('change'); $(document.getElementById('nom_prov')).trigger('input').trigger('change');
      }
    });

    // Llamar a cargarDatos al final para asegurar que todo el DOM esté listo y los listeners adjuntos.
    cargarDatos();// CORRECCIÓN: Mover el listener de .file-input DENTRO del $(document).ready()
    // para que tenga acceso a 'documentosRequeridosIds' y 'actualizarUICardDocumento'
    // que también están definidas o se usan dentro de este scope.
    document.querySelectorAll('.file-input').forEach(input => {
      input.addEventListener('change', function() { 
        const fileInputId = this.id;
        const fileName = this.files[0] ? this.files[0].name : null;
        const esRequerido = documentosRequeridosIds.includes(fileInputId); // Accede a la variable del scope de ready
        
        actualizarUICardDocumento(fileInputId, fileName, '#', esRequerido); // Llama a la función helper

        if (this.files[0]) { // Validaciones frontend opcionales
            const maxFileSize = 5 * 1024 * 1024; 
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (this.files[0].size > maxFileSize) {
                alert(`El archivo "${fileName}" es demasiado grande (máx. 5MB). No se subirá.`); this.value = ''; 
                actualizarUICardDocumento(fileInputId, null, '#', esRequerido); 
                return;
            }
            if (!allowedTypes.includes(this.files[0].type)) {
                alert(`Tipo de archivo no permitido para "${fileName}". Permitidos: PDF, JPG, PNG, DOC, DOCX.`); this.value = ''; 
                actualizarUICardDocumento(fileInputId, null, '#', esRequerido); 
                return;
            }
        }
      });
    });

  }); // Fin de $(document).ready()

  // Funciones globales (o que necesitan serlo)
  function logout() { sessionStorage.removeItem('jwt'); window.location.href = '/Proveedores/acceder/'; }
  function goToDashboard() { window.location.href = '/Proveedores/dashboard/'; }
  function triggerUpload(fileInputId) { document.getElementById(fileInputId).click(); }
  
  function viewDocument(path) { 
    if (path && path !== '#' && !path.startsWith('blob:')) { // No intentar abrir URLs blob directamente así si son locales
        window.open(path, '_blank'); 
    } else if (path && path.startsWith('blob:')) {
        // Para blobs (previsualización local), el usuario ya lo "vio" al seleccionarlo.
        // O podrías intentar mostrarlo en un modal si es una imagen.
        // Por ahora, solo no hacemos nada o un alert.
        alert('El archivo está seleccionado localmente. Se enviará al guardar.');
    }
    else { 
        alert('El documento aún no ha sido cargado o no hay una URL válida. Intente guardar los cambios primero.');
    }
  }
  </script>
</body>
</html>